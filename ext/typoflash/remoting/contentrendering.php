<?php
/*


This script is copyright Andreas Borg. borg@elevated.to

This constitutes the "armlength" interface between my TypoFlash editor
and Typo3.

From GPL licence

I'd like to incorporate GPL-covered software in my proprietary system. Can I do this? 
You cannot incorporate GPL-covered software in a proprietary system. The goal of the GPL is to grant everyone the freedom to copy, redistribute, understand, and modify a program. If you could incorporate GPL-covered software into a non-free system, it would have the effect of making the GPL-covered software non-free too. 
A system incorporating a GPL-covered program is an extended version of that program. The GPL says that any extended version of the program must be released under the GPL if it is released at all. This is for two reasons: to make sure that users who get the software get the freedom they should have, and to encourage people to give back improvements that they make.

However, in many cases you can distribute the GPL-covered software alongside your proprietary system. To do this validly, you must make sure that the free and non-free programs communicate at arms length, that they are not combined in a way that would make them effectively a single program.

The difference between this and "incorporating" the GPL-covered software is partly a matter of substance and partly form. The substantive part is this: if the two programs are combined so that they become effectively two parts of one program, then you can't treat them as two separate programs. So the GPL has to cover the whole thing.

If the two programs remain well separated, like the compiler and the kernel, or like an editor and a shell, then you can treat them as two separate programs--but you have to do it properly. The issue is simply one of form: how you describe what you are doing. Why do we care about this? Because we want to make sure the users clearly understand the free status of the GPL-covered software in the collection.

If people were to distribute GPL-covered software calling it "part of" a system that users know is partly proprietary, users might be uncertain of their rights regarding the GPL-covered software. But if they know that what they have received is a free program plus another program, side by side, their rights will be clear. 



////
Configuration variables set in TS setup and TS constants are residing here normally
$GLOBALS[TSFE]->tmpl->setup[plugin.]...
tmpl is generated by t3lib_TStemplate, but since we are not using TSFE we are not using
that class by default. Remoting doesn't have to use TS setup values. It is quite easy to keep
its config completely separate, but in the spirit of parallelism it is useful, eg. if someone
has problems half way through registration process, to have a html version to pick up.
However, one of the benefits of not using TSFE is so that we don't need to generate and
parse TS every time. TS is cached though at every first visit to a page, and that

 t3lib_div::md5int('');//yields 222419149 which is the mpvar_hash for most records in cache_pagesection 
	
	Get template variables:
	-$this->conf = $this->getTSsetup(array('id'=>$usrObj['pid']),$this->prefixId);
	Get global cofn vars for plugin
	-unserialize($GLOBALS['TYPO3_CONF_VARS']['EXT']['extConf']['mus']);



$error = array("errortype"=>1,"errormsg"=>"No pid given"); 
return $error; 
//errortypes 
0 = no error
1 = user input error, can proceed
2 = server error, try later
3 = serious server error, bloody stuck


**************************
04/06/2006
Notes trying to explain to myself what I have done.

PLUGINS vs FLASH PAGE CONTENT
Flash content can be put in pages in two ways. Firstly as a plugin and secondly as flash page content. The former
uses flexiform, and the second uses normal page records. These contents are merged into one content array, so flash doesn't 
see any difference between the two. The former way has been left like an undeveloped appendix for future use, the primary 
function would be for parallel html/flash sites where the html site is using inline flash elements as well. The normal way
of creating full-frame flash sites is to create a template record, a set of flash components, and then create flash page
content on each page, selecting one of these components and any eventual records linked to them. The two ways of creting
flash content stores linked records differently - plugin uses the flexform format, and flash page content plain text.

MOTHERLOAD vs GET PAGE/RECORDS
Instead of asking for each page over and over again menus ask for the entire site structure in one go. Since this
is cached it is really not that expensive. However it is no simple question to decide whether all linked records
should be part of the motherload as well. I think this needs to be determined on a site-by-site basis cause although
pretty much all sites I have built up till now could apply this method with positive effects, a really content heavy
site, with lots and lots of new copy everyday could be heavy to load up. Then each component should have the
possibility to retrieve its own linked records independently.

TODO
-Handle recordset limits and offsets for paging results


26 / 08 / 2009
News and DAM
I now decided to consider these extensions part of the core offering of TypoFlash in the sense that
calls to them will be patched via ContentRendering instead of in a separate extension. There are always
issues with versions and I will have to be clear on what extension versions (or patches) TypoFlash is
working with , but to get both Media and Categoriesed Items (News etc) must be central to any CMS, not just
pages.

*/

//require_once('../../flashremoting/lib/typo3/includes.php');		
require_once(dirname(dirname(dirname(__FILE__))).'/flashremoting/lib/typo3/includes.php');	
require_once(PATH_t3lib.'class.t3lib_tstemplate.php');
require_once(PATH_t3lib.'class.t3lib_page.php');
require_once(PATH_t3lib.'class.t3lib_cs.php');
//23/07/2006 added to extract typo3 transformed content
require_once(PATH_t3lib."class.t3lib_parsehtml.php");
require_once(PATH_t3lib."class.t3lib_parsehtml_proc.php");
//require_once(PATH_t3lib."class.t3lib_befunc.php");
require_once(PATH_t3lib."class.t3lib_div.php");
require_once(PATH_t3lib.'class.t3lib_htmlmail.php');
//require_once('../../../../typo3/sysext/cms/tslib/class.tslib_content.php');



    class contentrendering extends flashremoting_base{

	    var $id;
		var	$MP;
		var $prefixId = "contentrendering";		// Same as class name
		var $scriptRelPath = "remoting/contentrendering.php";	// Path to this script relative to the extension dir.
		var $extKey = "typoflash";	// The extension key.
		var $cObj;
		var $conf = array();
		var $site_url;
		var $motherload = array();//will build up all content

        function contentrendering() {
		
			parent::flashremoting_base();//get method table and some globals etc
			
			/* Removed in AMFPHP 1.9
            $this->subMethodTable = array(
				 "getPage" => array(
					"description" => "Returns all flash components and their records if user has page access. Accepts no_cache.",
					"access" => "remote"
				),
				"getMenu" => array(
					"description" => "Returns a menu object with id as pid. All pages are nested in subpages array. Accepts type=FEmenu or BEmenu, L, no_cache, doktype SQL clause starting with AND.., showHiddenPage, showDeletedPage, showTimedPage, menuId and array of fields",
					"access" => "remote"
				),
				"getMotherload" => array(
					"description" => "Returns an array of all subpages of page with id x. Use to retrieve a whole website in one go, instead of doing getPage calls everytime. If getRecords=false it will not extract linked records inside components but send the typo3 format string. eg tt_content_84,tt_content_49. Accepts wrap for links",
					"access" => "remote"
				),
				"getRecords" => array(
					"description" => "Returns an array of records asked for in the format obj.records=tt_content_84,tt_content_49,obj.orderBy = name. Prefix either tt_ or tx_ only",
					"access" => "remote"
				),
				"getRenderedContent" => array(
					"description" => "Returns any tt_content rendered like in FE, ie. in html, asked for in format obj.records=tt_content_84,tt_content_49",
					"access" => "remote"
				),
				"getMedia" => array(
					"description" => "Returns any media asked for in format obj.media=2,3,4,7 or obj.media=tx_dam_6,tx_dam_8, obj.useSorting",
					"access" => "remote"
				),
				"getMediaFromCategory" => array(
					"description" => "Returns any media asked for in format obj.media_category=2,3,4,7, obj.L=1, obj.returnTree = true",
					"access" => "remote"
				),
				"getLanguages" => array(
					"description" => "Returns a list of available system languages and their codes. You can pass a uid to check if exists.",
					"access" => "remote"
				),
				"clearCache" => array(
					"description" => "Cleans out cached files.",
					"access" => "remote"
				)

            );

			
			$this->methodTable = array_merge($this->methodTable, $this->subMethodTable);*/
			$this->site_url = t3lib_div::getIndpEnv('TYPO3_SITE_URL');
			if($GLOBALS['TYPO3_CONF_VARS']['SYS']['setDBinit'] !=''){
				$GLOBALS['TYPO3_DB']->sql(TYPO3_db, $GLOBALS['TYPO3_CONF_VARS']['SYS']['setDBinit']);
			}
		
		}

		/*

		function _authenticate($role){
			return $role;
		}
        */



		/*
		Motherload is supposed to return a flat array with pid as index. Since its a simple lookup table there is no need to nest it. Its enough to keep it
		as a box of cards where each card is each page content. Flash can lookup to see if it has a local version of a page, else will need to request
		from server.
		
		*/
		
		
		function getMotherload($pObj=array()){
			global $BE_USER,$FE_USER,$EXEC_TIME,$TYPO3_DB,$TT,$TSFE;

			
			$pObj = (array) $pObj;//make sure swx objects are cast as array
			if(isset($pObj['fields']) || isset($pObj->fields)){
				$pObj['fields'] = (array) $pObj['fields'];	
			}

			if($FE_USER->user['uid']>0){
				//logged in
				if($FE_USER->user['usergroup']){
				//should be in usergroup but if not to prevent sql error
					$ug = $FE_USER->user['usergroup'] .',';
				}else{
					$ug='';
				}
				$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
			}else{
				//-1 hide at login, -2 show at login
				$fe_access =' AND fe_group IN (0,-1)';
			}
			
			
			/*
			Check BE user access
			*/
			if($BE_USER->user['uid']>0){
				//$be_access = ' AND '.$BE_USER->getPagePermsClause(1);
				$be_access ='';
			}else {
				$be_access ='';
			}	


			if($pObj['L']>0){
				$L = $this->getLanguages($pObj['L']);
				if($L[0]['isocode']){
						$isocode = 	$L[0]['isocode'];
						$sys_language_uid = $pObj['L'];
				}
			}else{
				$isocode = 	'DEF';
				$sys_language_uid = 0;
			}

			/*
			First check if already cached
			Needs to consider login status
			*/
			$pObj['callee'] = 'getMotherload';
			$pObj['loginstatus'] = $fe_access.$be_access;
			if(!$pObj['no_cache']){
				$t = serialize($pObj);
				$hash = md5($t);
				$c = $this->getHash($hash,0);
				$content = unserialize($c);
				if(is_array($content)){
					return $content;
					die;
				}
			}
			
			/*
			
			*/

			if($pObj['getRecords'] != false){
				$pObj['getRecords'] = true;
			
			}



			/*
			Preview options
			*/
			if($pObj['showHiddenPage']){
				$hide = '';
				$this->showHiddenPage = 1;
			}else{
				$hide =' AND hidden !=1';
				$this->showHiddenPage = 0;
			}

			if($pObj['showDeletedPage']){
				$delete = '';
			}else{
				$delete =' AND deleted !=1';
			}

			if($pObj['showTimedPage']){
				$time = '';
			}else{
				$time =' AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.')';
			}


			/*
			doktype options
			*/
			if($pObj['doktype']){
				$doktype = $pObj['doktype'];
			}else{
				$doktype = ' AND doktype IN (1,2,3,4,7)';
			
			}

			/*
			Page id options
			*/
			if(!($pObj['id']>0) && !(strlen($pObj['id'])>0)){
				$error = array('errortype'=>1,'errormsg'=>'No pid sent');
				return $error;
				die;
			}else if($pObj['id']>0){
				$page = 'uid='.intval($pObj['id']);
			}else{
				//alias sent
				$page = 'alias="'.$pObj['id'].'"';
			}

			

			$access = $hide.$delete.$time.$be_access.$fe_access.$doktype;
			$where = $page .$access;

			

			
			$res = $TYPO3_DB->exec_SELECTquery('*', 'pages', $where, '', 'sorting');
			$row = $TYPO3_DB->sql_fetch_assoc($res);
			$root_pid = $row['uid'];
			
			if(!($root_pid>0) && ($pObj['id']!=0)){
				//Didn't ask for root page with pid=0
				$error = array('errortype'=>1,'errormsg'=>'No page found with id '.$pObj['id'] );
				return $error;
				die;
			}
			$arr = array();
			
			//$arr['pages'] = array('associate'=>'array');
			$arr['pages'] = array();
			$this->addToMotherload($root_pid,$sys_language_uid,array('uid'),$access);
			//$arr['pages'] = $this->motherload;
			//$arr['pages'] = array_merge($arr['pages'],$this->addToMotherload($root_pid,$sys_language_uid,array('uid'),$access));
			

			foreach($this->motherload as $k=>$v){
				$v['L'] = $sys_language_uid;
				$v['id'] = $v['uid'];
				$v['showHiddenPage'] = $pObj['showHiddenPage'];
				$v['showDeletedPage'] = $pObj['showDeletedPage'];
				$v['showTimedPage'] = $pObj['showTimedPage'];
				$v['fields'] = $pObj['fields'];
				$v['getRecords'] = $pObj['getRecords'];//04/03/2007 MODIFIED	
				$v['wrap'] = $pObj['wrap'];//13/01/2008 MODIFIED	
				if($v['id']>0){
					$arr['pages'][$k] = $this->getPage($v);
				}
			
			}
			unset($pObj['fields']);//ever needed in return?

			$arr['pObj'] = $pObj;
			
			//$arr['pages'] = (object) $arr['pages'];

			/*
			Save to cache
			*/
			if($pObj['no_cache']){
				//Wasn't done above if so
				$t = serialize($pObj);
				$hash = md5($t);
			}
			$data = serialize($arr);
			
			$this->storeHash($hash,$data,'REMOTING_motherload');
			
			//$arr['pages'] = (object) $arr['pages'];

			return (object) $arr;

		}
		
		function getPage($pObj=array()){
			
			global $BE_USER,$FE_USER,$EXEC_TIME,$TYPO3_DB,$TT,$TSFE;
			
			$pObj = (array) $pObj;

			if($FE_USER->user['uid']>0){
				//logged in
				if($FE_USER->user['usergroup']){
				//should be in usergroup but if not to prevent sql error
					$ug = $FE_USER->user['usergroup'] .',';
				}else{
					$ug='';
				}
				$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
			}else{
				//-1 hide at login, -2 show at login
				$fe_access =' AND fe_group IN (0,-1)';
			}

			/*
			Check BE user access
			$BE_USER->getPagePermsClause(1)
			traces eg.
			((pages.perms_everybody & 1 = 1)OR(pages.perms_userid = 2 AND pages.perms_user & 1 = 1))
			for non-admin user

			Might need to reinstate is show hidden pages etc. Disabled temporarily
			06/05/2008
			*/
			if($BE_USER->user['uid']>0){
				//$be_access = ' AND '.$BE_USER->getPagePermsClause(1);
				$be_access = '';
			}else {
				$be_access ='';
			}	

			if(isset($pObj['fields']) || isset($pObj->fields)){
				$pObj['fields'] = (array) $pObj['fields'];	
			}


			/*
			First check if already cached
			Needs to consider login status
			*/
			$pObj['loginstatus'] = $fe_access.$be_access;
			if(!$pObj['no_cache']){
				$t = serialize($pObj);
				$hash = md5($t);
				$c = $this->getHash($hash,0);
				$content = unserialize($c);
				if(is_array($content)){
					return $content;
					die;
				}
			}
			
			if(!isset($pObj['getRecords'])){
				$pObj['getRecords'] = true;
			
			}
			$extractLinkedRecords = $pObj['getRecords'];	
			/*
			Preview options
			*/
			if($pObj['showHiddenPage']){
				$hide = '';
				$this->showHiddenPage = 1;
			}else{
				$hide =' AND hidden !=1';
				$this->showHiddenPage = 0;
			}

			if($pObj['showDeletedPage']){
				$delete = '';
			}else{
				$delete =' AND deleted !=1';
			}

			if($pObj['showTimedPage']){
				$time = '';
			}else{
				$time =' AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.')';
			}
			/*
			Field options
			*/
			if(!(is_array($pObj['fields']))){
				$pObj['fields'] =array('uid','pid','title','storage_pid','sys_language_uid','nav_title','subtitle','url','target','media','description','author','abstract','alias','doktype','shortcut','shortcut_mode');
			}
			/*
			Page id options
			*/
			if(!($pObj['id']>0) && !(strlen($pObj['id'])>0) && !(strlen($pObj['alias'])>0)){
				$error = array('errortype'=>1,'errormsg'=>'No id or alias sent');
				return $error;
				die;
			}else if($pObj['id']>0){
				$page = 'uid='.intval($pObj['id']);
			}else if($pObj['alias']){
				//alias sent
				$page = 'alias="'.$pObj['alias'].'"';
			}

			

			$access = $hide.$delete.$time.$be_access.$fe_access;
			$where = $page .$access;
			

			$res = $TYPO3_DB->exec_SELECTquery('*', 'pages', $where, '', '');

			$row = $TYPO3_DB->sql_fetch_assoc($res);
			if(!$row){
				$error = array('errortype'=>1,'errormsg'=>'No accessible page found');
				return $error;
				die;
			
			}
			
			$pageRecord = array();

			foreach($pObj['fields'] as $k=>$v){
				 $pageRecord[$v] = $row[$v];
			}
			

		// *****************************************
		// We are passing L for language. 
		// *****************************************


		if($pObj['L']>0){
			$L = $this->getLanguages($pObj['L']);
			if($L[0]['isocode']){
					$isocode = 	$L[0]['isocode'];
					$sys_language_uid = $pObj['L'];
			}else{
				$err = array('errortype'=>'2','errormsg'=>'Language "'.$pObj['L'] . '" not found in language table. Check your language settings in Typo3','L'=>$L);
				return $err;
			}
		
		}else{
			$isocode = 	'DEF';
			$sys_language_uid = 0;
		}


		/*
		Language options
		*/
		if($pObj['L']>0){
			//It's also different from zero
			$pageRecord = $this->getPageOverlay($row,intval($pObj['L']));
		}

		// ********************************
		// Store session data for fe_users
		// ********************************
		if($FE_USER){
			$FE_USER->storeSessionData();
		}
	
		$arr = array();
		$arr['HEADER'] = array();
		//filtering out some hopefully unecessary fields to speed things up 10/10/2007
		foreach($pObj['fields'] as $v){
				$arr['HEADER'][$v] = $pageRecord[$v];
		}
		//$arr['HEADER'] = $pageRecord;
		$arr['TEMPLATE'] = $this->getFlashTemplate($row);
		
		//First get tt_content plugins
		//Plugins should be retrieved separately...better to keep html/typoflash to each side
		//$arr['CONTENT'] = $this->getFlashComponents($row['uid'],$isocode,$extractLinkedRecords,$pObj['wrap']);

		//Then get flash content from tx_typoflash_content
		//$arr['CONTENT'] = array_merge($arr['CONTENT'],$this->getFlashContent($row['uid'],$sys_language_uid,$isocode,$extractLinkedRecords,$pObj['wrap']));
		
		$arr['CONTENT'] = $this->getFlashContent($row['uid'],$sys_language_uid,$isocode,$extractLinkedRecords,$pObj['wrap']);


		/*
		Save to cache
		*/
		if($pObj['no_cache']){
			//Wasn't done above if so
			$t = serialize($pObj);
			$hash = md5($t);
		}
		$data = serialize($arr);
		
		$this->storeHash($hash,$data,'REMOTING_content');
	
		unset($pObj['fields']);//ever needed in return?
		$arr['pObj'] = $pObj;

		return $arr;

    }

	function array_is_associative ($array)
	{

		if ( is_array($array) && ! empty($array) )
		{
			for ( $iterator = count($array) - 1; $iterator; $iterator-- )
			{
				
				if ( ! array_key_exists($iterator, $array) ) { return true; }
			}
			return ! array_key_exists(0, $array);
		}
		return false;
	}




	function getFlashTemplate($pageRecord)    {
		global $TYPO3_DB;
		
		/*
		 A note on configuration.
		 3 (!) sets of configuration variables will be sent back to flash
		 i. from flash record
		 ii. from page where root template resides
		 iii. from page record (with or without flash template)
		
		 In flash this is also the order in which they will be written into the loaded template movieclip.
		 Hence, if same variable is set in all thee sets the page specific one will take precedence

		 In addition both pages and tt_content has a 'tx_typoflash_data' field which can be used to store serialized
		 datastructures for pages and components. For templates you can return both a template level data structure and a
		 page-specific one. For components there is only a page level on, and it is the same for all languages. Hence, you will
		 need to specify language for the data IN the data. 

		 tx_typoflash_data is stored in the namespace of the template id, then language, then glue key name
		*/


		//Store page specific conf and data
		$pageRecord['page_conf'] = $pageRecord['tx_typoflash_conf'];
		$all_data = unserialize( $pageRecord['tx_typoflash_data']);
		$pageRecord['page_data'] = $all_data[$pageRecord['tx_typoflash_template']];
		$pageRecord['template_data'] = null;//If current page contains template_data it will be considered page_data 
		$pageRecord['template_pid'] = $pageRecord['uid'];
			// Find Template in root line IF there is no Data Structure set for the current page:
		if (!$pageRecord['tx_typoflash_template'])	{
			$p = $pageRecord['pid'];
			//Search for template near root
			while($p){
				
				$res = $TYPO3_DB->exec_SELECTquery('*', 'pages', 'uid=' .$p, '', '');
				$pRec = $TYPO3_DB->sql_fetch_assoc($res);
				
				if($pRec['tx_typoflash_template']>0){
					//Store template specific conf and data
						$pageRecord['template_pid'] = $pRec['uid'];
						$pageRecord['tx_typoflash_template'] = $pRec['tx_typoflash_template'];
						$pageRecord['template_conf'] = $pRec['tx_typoflash_conf'];
						$all_data = unserialize($pRec['tx_typoflash_data']);
						$pageRecord['template_data'] = $all_data[$pRec['tx_typoflash_template']];
						//$pageRecord['template_data'] = unserialize( $pRec['tx_typoflash_data']);
						//$pageRecord['template_data'] = "Got this in ".$pRec['uid'];
						break;
						
				}else{
					$p = $pRec['pid'];
				}
			}

		}

		return $this->getTemplateRecord($pageRecord);
    }


	function getTemplateRecord($row)	{
		global $TYPO3_DB;
		
		$res = $TYPO3_DB->exec_SELECTquery('*', 'tx_typoflash_template', 'uid=' .$row['tx_typoflash_template'], '', '');
		$fTemplate = $TYPO3_DB->sql_fetch_assoc($res);
		$fTemplate['base'] = 'uploads/tx_typoflash/';
		$fTemplate['page_conf'] = $row['page_conf'];
		$fTemplate['template_conf'] = $row['template_conf'];
		
		//stupid swx work around as it casts objects as numerical arrays
		$row['page_data']['lang'] = 'true';

		/*$fTemplate['page_data'] = array('associative'=>'true');
		foreach($row['page_data'] as $k=>$v){
			$fTemplate['page_data'][$k] = (object) $v;

		}*/
		
		$fTemplate['page_data'] = $row['page_data'] ;


		/*$fTemplate['template_data'] = array('associative'=>'true');
		foreach($row['template_data'] as $k=>$v){
			$fTemplate['template_data'][$k] = (object) $v;

		}*/
		$row['template_data']['lang'] = 'true';
		$fTemplate['template_data'] = $row['template_data'];

		$fTemplate['template_pid'] = $row['template_pid'];
		return $fTemplate;
	}
	


	/*
	Get tt_content inserted by means of a plugin on a normal page
	*/
		
	function getFlashComponents($pid,$L= 'DEF',$extractLinkedRecords,$linkwrap=''){
		global $TSFE,$EXEC_TIME,$FE_USER;

		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}

		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('header,list_type,pid,uid,subheader,pi_flexform,fe_group,tx_typoflash_data', 'tt_content', 'NOT deleted AND NOT hidden AND pid='.$pid.' AND list_type LIKE "typoflash%" AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access);

		$flashRecs = array();
		while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{
			$row['pi_flexform'] = $data  = t3lib_div::xml2array($row['pi_flexform']);
			//build lanugage key...like lES, or lSE...default is lDEF
			$lKey = 'l'.$L;
			$cid = $data['data']['sDEF'][$lKey]['tx_typoflash_component']['vDEF'];//component id
			if($cid){
				//filter out on language
				$row['component'] = $this->getComponent($cid);
				$row['path'] = 'uploads/tx_typoflash/';
				$row['conf'] = $data['data']['sDEF'][$lKey]['conf']['vDEF'];
				$row['target'] = $data['data']['sDEF'][$lKey]['target']['vDEF'];
				$row['language'] = $data['meta']['currentLangId'][0];//eg ES, SV
				if(!$extractLinkedRecords){
					$row['records'] = $data['data']['content_records'][$lKey];
				}else{
					$row['records'] = $this->getComponentRecords($data['data']['content_records'][$lKey],$lKey,$linkwrap);
				}
				$row['component_data'] = unserialize($row['tx_typoflash_data']);
				unset($row['tx_typoflash_data']);
				unset($row['pi_flexform']);//uncomment if you don't want to send back all this
			}else{
				//don't send back those with wrong lanugage
				unset($row);
			}

			$flashRecs[] = $row;

		}

		return $flashRecs;
		/*
		Note that lES and lDEF refers to language requested.

		{data: {
		content_records: {lES: {orderBy: {vDEF: "2"}, 
			 pages: {vDEF: "13"}, 
			 recordLimit: {vDEF: "5"}, 
			 records: {vDEF: "tt_content_31,tt_content_2"}, 
			 tables: {vDEF: "tt_news,tt_content"}}}, 
		 sDEF: {lES: {
			 conf: {vDEF: "news=1&flop=true"}, 
			 path: {vDEF: ""}, 
			 tx_typoflash_component: {vDEF: "1"}}}}, 
		 meta: {currentLangId: ["ES"]}}, 
		*/
	
	}

	function getComponent($uid){
		global $TSFE,$EXEC_TIME,$FE_USER;

		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}

		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tx_typoflash_component', 'NOT deleted AND NOT hidden AND uid='.$uid.' AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access);

		
		$row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res);
		return $row;
	}




	function getComponentRecords($recs,$lKey,$linkwrap=''){
		global $TSFE,$EXEC_TIME,$TCA,$TYPO3_DB,$FE_USER;
		/*orderBy: {vDEF: "2"}, 
			 pages: {vDEF: "13"}, 
			 recordLimit: {vDEF: "5"}, 
			 records: {vDEF: "tt_content_31,tt_content_2"}, 
			 tables: {vDEF: "tt_news,tt_content"}}}, */
		//return $recs['orderBy']['vDEF'];

	
		
		
		$records = array();//add all different recs to this array
		


		/*
		Check user access
		*/
		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}
		
		
		/*
		Field ordering
		*/

		$oFields = array('0'=>'','1'=>'uid','2'=>'name','3'=>'title','4'=>'crdate','5'=>'pid');
		if($recs['orderBy']['vDEF']){
			$orderField = $oFields[$recs['orderBy']['vDEF']];
		}else{
			$orderField ='uid';
		}
		
		/*
		Limit
		*/
		if($recs['recordLimit']['vDEF']){
			$limit = $recs['recordLimit']['vDEF'];
		}else{
			$limit ='';
		}

		/*
		Get tables to read. tt_content by default
		Get whole table definition for this field. If not found in TCA it will be ignored.
		*/
		
		if(strlen($recs['tables']['vDEF'])>0){
			$tables = explode(',',$recs['tables']['vDEF']);
			foreach($tables as $k =>$v){
				if($TCA[$v]){
					if($TCA[$v]['ctrl']['dynamicConfigFile']){
						require_once($TCA[$v]['ctrl']['dynamicConfigFile']);	
					}
				}else{
					
					unset($tables[$k]);
					$err = array('errortype'=>'2','errormsg'=>'Table "'.$v . '" not found in TCA');
					return $err;
				}
			}
		}else{
			$tables = array(0=>'tt_content');
		}

		

		$pages = explode(',',$recs['pages']['vDEF']);
		foreach($pages as $k =>$pid){
			foreach($tables as $n=>$tn){
				//check if table and fields exist
				if($TCA[$tn] && t3lib_div::testInt($pid) ){
					
					if($tn=='tt_content'){
						$fields = 'uid,CType,bodytext,fe_group,header,subheader,image,header_link,list_type,media,multimedia,pid,records,sys_language_uid,pi_flexform';
						$where = ' AND NOT deleted AND NOT hidden AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access;

					}else{
						$fields ='*';
						$where = $this->deleteClause($tn) . $this->enableFields($tn);
					}
					
					

					
					


					$res = $TYPO3_DB->exec_SELECTquery ($fields, $tn, 'pid= ' .$pid . $where, '', $orderBy);
					while ($row = $TYPO3_DB->sql_fetch_assoc($res))	{
						//return ($tn .' , '.join(',',$TCA[$tn]).' , '.$pid.' , '.$orderBy.',' .$limit);
						//$records = array_merge($records, $this->getRecordsByField($tn, 'pid',$pid,$where,'',$orderBy,$limit));//add new records to the end of array
						
						if($tn=='tt_content'){
							$row['path'] = $this->getPath($row['CType'],$row['list_type']);
							if(strlen($row['pi_flexform'])>0){
								$row['pi_flexform'] = t3lib_div::xml2array($row['pi_flexform']);
							}else{
								unset($row['pi_flexform']);
							}
							if(strlen($row['bodytext'])>0){
								$row['bodytext'] = $this->parseText($row['bodytext'],$linkwrap);
							}
							if($row['header_link']){
								$row['header_link'] = $this->TS_links_rte($row['header_link'],$linkwrap);
							}
						}
						if($row['CType']=='shortcut' && $row['records']){
							//get linked records also
							$row['records'] = $this->getRecs($row['records'],$orderField,null,$linkwrap);

						}
						$records[] = $row; 
					}
				}
			}
			//return ($tn . $where.$orderBy.$limit);
			//return ($TCA[$tn]['columns']['fe_group'] .' ,1 '.$TCA[$tn]['columns']['deleted'] . ' ,2 '.$TCA[$tn]['columns']['hidden']. ' ,3 '.$TCA[$tn]['columns']['starttime'].' ,4 '. $TCA[$tn]['columns']['endtime'] );
		}
		
		/*
		Specific records
		*/
		if(strlen($recs['records']['vDEF'])>0){
			
				$records = array_merge($records, $this->getRecs($recs['records']['vDEF'],$orderField,$linkwrap));

					/*
					///.....get recs
					$records = array_merge($records, $this->getRawRecord($tn, $rid));//add new records to the end of array
					*/

		}

		/*$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('header,list_type,pid,uid,subheader,pi_flexform,fe_group', 'tt_content', 'NOT deleted AND NOT hidden AND pid='.$pid.' AND list_type LIKE "typoflash%" AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access);
		*/
		
		return $records;
	}

	




	function getFlashContent($pid,$L=0,$isocode,$extractLinkedRecords,$linkwrap=''){
		
		global $EXEC_TIME,$FE_USER;



		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}
	
		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('target,component,uid,pid,name,sys_language_uid,records,storage_page,media,media_category,conf,data,xml_conf,title,body_text', 'tx_typoflash_content', 'sys_language_uid='.$L.' AND NOT deleted AND NOT hidden AND pid='.$pid.' AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access);
				
		$flashRecs = array();
		while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{
			$cid = $row['component'];//component id
			$lKey = 'l' .$isocode ;
			if($cid){
				//filter out on language
				$row['component'] = $this->getComponent($cid);
				$row['path'] = 'uploads/tx_typoflash/';
				if(!$extractLinkedRecords){
					$row['records'] = $row['records'];
				}else{
					$row['records'] = $this->getRecs($row['records'],'',$L,$linkwrap);
				}

				/*
				Extract all tt_content records from storage_page
				*/
				if($row['storage_page']>0){
					$row['records'] = array_merge($row['records'],$this->getRecsFromPage('tt_content',$row['storage_page'],$L,$linkwrap)); 
				}
	
				$row['component_data'] = unserialize($row['data']);
				unset($row['data']);
			}
			$flashRecs[] = $row;

		}

		return $flashRecs;
		/*
		Note that lES and lDEF refers to language requested.

		{data: {
		content_records: {lES: {orderBy: {vDEF: "2"}, 
			 pages: {vDEF: "13"}, 
			 recordLimit: {vDEF: "5"}, 
			 records: {vDEF: "tt_content_31,tt_content_2"}, 
			 tables: {vDEF: "tt_news,tt_content"}}}, 
		 sDEF: {lES: {
			 conf: {vDEF: "news=1&flop=true"}, 
			 path: {vDEF: ""}, 
			 tx_typoflash_component: {vDEF: "1"}}}}, 
		 meta: {currentLangId: ["ES"]}}, 

		
		04/06/2006
		It seems $row['records'] can take on different formats. 
		Sometimes (if there is no other active language perhaps) the records are not stored in flexform
		xml format but simply as a list of recs eg. tt_content_86,tt_content_92

		You need to look into how and why that works.

		
		*/
	
	}



	/*
	Media is nested so that the record is in the item property and the overlays in the lang array
	$pObj['useSorting'] can be used to override manual ordering of records inside the compoents
	*/

	function getMedia($pObj){

		global $TSFE,$EXEC_TIME,$FE_USER;
		
		if(!strlen($pObj['media'])>0){
			return $pObj;
		}
		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}
		
		if(strrpos($pObj['media'],'_')>0){
			//media sent in recs format...ie used as normal html page content..lets convert
			$ma = explode(',',$pObj['media']);
			$pObj['media'] = $this->getRecordId($ma[0]);
			
			foreach($ma as $k=>$v){
				if($k>0){
					$pObj['media'].= ','.$this->getRecordId($v);	
				}
			
			}
		}
		
		//return $pObj['media'];
		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('uid,pid,tstamp,crdate,cruser_id,parent_id,deleted,active,sorting,hidden,starttime,endtime,fe_group,sys_language_uid,l18n_parent,media_type,title,category,index_type,file_mime_type,file_mime_subtype,file_type,file_type_version,file_name,file_path,file_size,file_mtime,file_inode,file_ctime,file_hash,file_status,file_orig_location,file_orig_loc_desc,file_creator,file_dl_name,file_usage,meta,ident,creator,keywords,description,alt_text,caption,abstract,search_content,language,pages,publisher,copyright,instructions,date_cr,date_mod,loc_desc,loc_country,loc_city,hres,vres,hpixels,vpixels,color_space,width,height,height_unit', 'tx_dam', 'NOT deleted AND NOT hidden AND (uid IN ('.$pObj['media'].') OR l18n_parent IN ('.$pObj['media'].')) AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access,'','sorting');


		//sorting them according to the order in which they were listed, ie. not according to "sorting" field

		$tempRecs = array();
		$orderedRecs = array();
		while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{
			//$row['pi_flexform'] = $data  = t3lib_div::xml2array($row['pi_flexform']);
			//build lanugage key...like lES, or lSE...default is lDEF
			//$lKey = 'l'.$L;
			//$cid = $data['data']['sDEF'][$lKey]['tx_typoflash_component']['vDEF'];//component id
			/*if($cid){
				//filter out on language
				$row['component'] = $this->getComponent($cid);
				$row['path'] = 'uploads/tx_typoflash/';
				$row['conf'] = $data['data']['sDEF'][$lKey]['conf']['vDEF'];
				$row['target'] = $data['data']['sDEF'][$lKey]['target']['vDEF'];
				$row['language'] = $data['meta']['currentLangId'][0];//eg ES, SV
				if(!$extractLinkedRecords){
					$row['records'] = $data['data']['content_records'][$lKey];
				}else{
					$row['records'] = $this->getComponentRecords($data['data']['content_records'][$lKey],$lKey);
				}
				$row['component_data'] = unserialize($row['tx_typoflash_data']);
				unset($row['tx_typoflash_data']);
				unset($row['pi_flexform']);//uncomment if you don't want to send back all this
			}else{
				//don't send back those with wrong lanugage
				unset($row);
			}*/

			
			if($row['l18n_parent']>0){
				if($tempRecs[$row['l18n_parent']]['lang'] != null){
					//If we have already the original in our temp array we should append our overlay
					
					$tempRecs[$row['l18n_parent']]['lang'][$row['sys_language_uid']] = $row;
				}else{
					//else the loop hasnt reached the original yet so we shuld create it here	
					$tempRecs[$row['l18n_parent']] = array('lang'=>array());
					$tempRecs[$row['l18n_parent']]['lang'][$row['sys_language_uid']] = $row;
				}
			}else{
				//only appending the original to the ordered list
				$orderedRecs[] = $tempRecs[$row['uid']] = array('lang'=>array(0=>$row,$row['sys_language_uid']=>$row));//we append row at both 0 and uid...most often they will be the same and thus overwrite eachother
				
			}

		}

		
		if($pObj['useSorting']){
			foreach ($orderedRecs as $k=>$v){
				//must reattach overlays to ordered list as it cant be done above
				$v[$k]['lang'] = $tempRecs[$v['uid']]['lang'];
			
			}
			$records = $orderedRecs;
		}else{
			$mRec = explode(',',$pObj['media']);
			$records = array();	
			foreach ($mRec as $i=>$uid){
				$records[] = $tempRecs[$uid];
			
			}
		}
		

		//used in flash to know which of several components called...can be used instead of unique callback
		//$records['menuId'] = $pObj['menuId'];

		$err = mysql_error(); 


		if($err==''){
			if($pObj['categoryRequest']){
				//asked for by getCategoryObject, no callback
				return $records;

			}else{
				return array('media'=>$records,'menuId'=>$pObj['menuId'],'callback'=>$pObj['callback']);
			}
		}else {
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;
		}
		/*
		Note that lES and lDEF refers to language requested.

		{data: {
		content_records: {lES: {orderBy: {vDEF: "2"}, 
			 pages: {vDEF: "13"}, 
			 recordLimit: {vDEF: "5"}, 
			 records: {vDEF: "tt_content_31,tt_content_2"}, 
			 tables: {vDEF: "tt_news,tt_content"}}}, 
		 sDEF: {lES: {
			 conf: {vDEF: "news=1&flop=true"}, 
			 path: {vDEF: ""}, 
			 tx_typoflash_component: {vDEF: "1"}}}}, 
		 meta: {currentLangId: ["ES"]}}, 
		*/
	
	}





	/*
	 obj.media_category=2,3,4,7, obj.L=1, obj.returnTree = true


	Categories will be returned in an array in the order they are listd. Each object however contains an object nested like a folder structure with respective media inside. The root object also has a flat list next to the ordered list, where all items are listed in natural order, useful when category selector isn't used.

	obj[subcat]  = array 
	obj[items]  = array in order of sorting of items
	obj[lang]  = array with uid of sys_lang as key...always 1-3 or something so ok to make numerical array
	obj[flatlist] = populated in natural order

	 [2][lang][1][title]
	 [2][subcat] = array

	 obj[items] here all items are listed according to the order of the categories and their internal sorting. Each category with child categories will be depleted before moving on.

	1. First need to get root
	 getCategoryObject - returns all translations and items of one category
	 getCategoryItems - returns all items, append these to flat list
	2. Get all categories with root as parent and nest them as subcat array if returnTree true

	 
	*/

	function getMediaFromCategory($pObj){

		global $TSFE,$EXEC_TIME,$FE_USER,$BE_USER,$FLAT_LIST;
		
		if(!strlen($pObj['media_category'])>0){
			return $pObj;
		}

	
		

		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}

	


		/*
		First check if already cached
		Needs to consider login status
		*/
		$pObj['loginstatus'] = $fe_access;
		if(!$pObj['no_cache']){
			$t = serialize($pObj);
			$hash = md5($t);
			$c = $this->getHash($hash,0);
			$menu = unserialize($c);
			if(is_array($menu)){
				return $menu;
				die;
			}
		}

		$FLAT_LIST = array();//reset this list so it can be filled at each call
		
		$cats = explode(',',$pObj['media_category']);
		
		//build array on category keys 
		$arr = array('categories'=>array());
		foreach($cats as $k=>$v){
				$arr['categories'][$v] = $this->getCategoryObject($this->getRecordId($v),$pObj);
		}
		/*//Get items
		//only main original category has items and subcats...remember that this is my version of dam with multilang categories
		$mObj = array();
		$mObj['useSorting'] = true;
		$mObj['categoryRequest'] = true;//used in getMedia above not to cache etc
		$mObj['media'] = $pObj['media_category'];
		$arr['items'] = $this->getMedia($mObj);
		*/
		
		$arr['flatlist'] = $FLAT_LIST;

		//used in flash to know which of several components called...can be used instead of unique callback
		$arr['menuId'] = $pObj['menuId'];
		/*
		Save to cache
		*/
		if($pObj['no_cache']){
			//Wasn't done above if so
			$t = serialize($pObj);
			$hash = md5($t);
		}
		$data = array('result'=>$arr,'callback'=>$pObj['callback']);
		$data = serialize($data);
		
		$this->storeHash($hash,$data,'REMOTING_mediacat');
		


		
		$err = mysql_error(); 
		if($err==''){
			return array('result'=>$arr,'callback'=>$pObj['callback']);
		}else {
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;
		}

	}

	

	//Used for getMediaFromCategory. See above
	function getCategoryObject($uid=null,$pObj){
		global $TSFE,$EXEC_TIME,$FE_USER,$BE_USER,$FLAT_LIST;

		$obj = array('subcat'=> array(),'items'=> array(),'lang'=> array());
	
		
		
		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND tx_dam.fe_group IN ('.$ug.'0,-2) AND tx_dam.fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND tx_dam.fe_group IN (0,-1)';
		}





//Get items in category

//uid,pid,tstamp,crdate,cruser_id,parent_id,deleted,active,sorting,hidden,starttime,endtime,fe_group,sys_language_uid,l18n_parent,media_type,title,category,index_type,file_mime_type,file_mime_subtype,file_type,file_type_version,file_name,file_path,file_size,file_mtime,file_inode,file_ctime,file_hash,file_status,file_orig_location,file_orig_loc_desc,file_creator,file_dl_name,file_usage,meta,ident,creator,keywords,description,alt_text,caption,abstract,search_content,language,pages,publisher,copyright,instructions,date_cr,date_mod,loc_desc,loc_country,loc_city,hres,vres,hpixels,vpixels,color_space,width,height,height_unit

		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tx_dam,tx_dam_mm_cat', ' NOT tx_dam.deleted AND NOT tx_dam.hidden AND tx_dam.uid=tx_dam_mm_cat.uid_local AND NOT tx_dam.l18n_parent>0 AND tx_dam_mm_cat.uid_foreign = '.$uid.' AND tx_dam.starttime<='.$EXEC_TIME.' AND (tx_dam.endtime=0 OR tx_dam.endtime>'.$EXEC_TIME.') '.$fe_access,'','tx_dam.sorting');


		//$obj['items'] =  $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res0);
		
		$orderedRecs = array();
		//store different rows on their syslang uid
	
		while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{

			$row['l18n_diffsource'] = '';
			$lang = array('lang'=>array());
			$lang['lang'][0] = $lang['lang'][$row['sys_language_uid']] = $row;//add row as both default and zero...bit tricky when same page tree has several different default languages...there is room for user input error
			
			//we wanna save overlays with the record, not as separate tables...cause that would be trickier to translate
			

			$OLres = $GLOBALS['TYPO3_DB']->exec_SELECTquery('uid,pid,tstamp,crdate,cruser_id,parent_id,deleted,active,sorting,hidden,starttime,endtime,fe_group,sys_language_uid,l18n_parent,media_type,title,category,index_type,file_mime_type,file_mime_subtype,file_type,file_type_version,file_name,file_path,file_size,file_mtime,file_inode,file_ctime,file_hash,file_status,file_orig_location,file_orig_loc_desc,file_creator,file_dl_name,file_usage,meta,ident,creator,keywords,description,alt_text,caption,abstract,search_content,language,pages,publisher,copyright,instructions,date_cr,date_mod,loc_desc,loc_country,loc_city,hres,vres,hpixels,vpixels,color_space,width,height,height_unit', 'tx_dam', ' NOT tx_dam.deleted AND NOT tx_dam.hidden AND tx_dam.l18n_parent= '.$row['uid'].' AND tx_dam.starttime<='.$EXEC_TIME.' AND (tx_dam.endtime=0 OR tx_dam.endtime>'.$EXEC_TIME.') '.$fe_access,'','tx_dam.sorting');
			
			while ($OLrow = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($OLres))	{
				$OLrow['l18n_diffsource'] = '';
				$lang['lang'][$OLrow['sys_language_uid']] = $OLrow;

			}

			$orderedRecs[] =  $lang;

		}
	
		$obj['items'] = $orderedRecs;

		$FLAT_LIST = array_merge($FLAT_LIST, $obj['items']);

		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}



//
		//Get language overlays

		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('uid,pid,tstamp,crdate,cruser_id,parent_id,deleted,sorting,hidden,fe_group,sys_language_uid,l18n_parent,title,image,nav_title,subtitle,keywords,description', 'tx_dam_cat', 'NOT deleted AND NOT hidden AND (uid = '.$uid.' OR l18n_parent = '.$uid.') '.$fe_access,'','sorting');	
		
//return $obj;

		while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{
			$row['path'] = 'uploads/tx_dam/';

			//Append alternative languages if any
			$obj['lang'][$row['sys_language_uid']]= $row;
			
			if(($row['l18n_parent']==0) && $pObj['returnTree']){
				$obj['lang'][0]= $row;//make sure defult one is at root as well

				//get children
				$res2 = $GLOBALS['TYPO3_DB']->exec_SELECTquery('uid,pid,tstamp,crdate,cruser_id,parent_id,deleted,sorting,hidden,fe_group,sys_language_uid,l18n_parent,title,image,nav_title,subtitle,keywords,description', 'tx_dam_cat', 'NOT deleted AND NOT hidden AND l18n_parent = 0 AND parent_id = '.$uid.$fe_access,'','sorting');		
				
				while ($row2 = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res2))	{
					$obj['subcat'][] = $this->getCategoryObject($row2['uid'],$pObj);
					
				}

			}
		}

		return $obj;

	}






	function getRecords($obj){
		
		//security check to exclude non tt_ and tx_ rec
		$prefixArr= array('tt','tx');
		$temp = explode(',',$obj['records']);
		$clean = array();
		if(is_array($temp)){
			
			foreach($temp as $k=>$rec){
				if($this->checkPrefix($rec,$prefixArr)){
					$clean[] = $rec;
				}
			}
		}else{
			return false;
		}

		if(count($clean)==0){
			//no clean recs to return 
			return false;
		}else{
			$clean = implode(',',$clean);
			$recs = $this->getRecs($clean,$obj['orderBy']);
			return $recs;
		}
	}



	/*
		Use this function to return records sending the "tx_flashtemplate_content_12,tx_flashtemplate_content_13" record format
	
	*/
	
	function getRecs($typo3rec, $orderField='',$L=0,$linkwrap='',$infinity=false){
		
		//
		global $FE_USER,$EXEC_TIME,$TCA,$TYPO3_DB;
		
		//Infinity is preventing infinite loops of linked records...crazy people might

		/*
		Check user access
		*/
		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}	
	
		$records = array();
		$fRecs = explode(',',$typo3rec);
		if($TCA==null){
			//added 04/06/2006
			$this->getCompressedTCarray();
		}
		foreach($fRecs as $k=>$v){
				
		//get table name and check against TCA...
				$tn = $this->getTableName($v);
				$rid = $this->getRecordId($v);
				if($TCA[$tn] && t3lib_div::testInt($rid)){
					if($TCA[$tn]['columns'][$orderField]){
						$orderBy = $orderField;
					}else{
						$orderBy ='';
					}

					if($tn=='tt_content'){
						$fields = 'uid,CType,bodytext,fe_group,header,subheader,image,list_type,media,header_link,multimedia,pid,records,sys_language_uid,pi_flexform,l18n_parent';
						$where = ' AND NOT deleted AND NOT hidden AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access;

					}else{
						$fields ='*';
						$where = $this->deleteClause($tn) . $this->enableFields($tn);
					}
					/*
					10/10/2007
					This makes linked records return the chosen language even if it is the language root record that is linked.
					
					*/
					if($L>0){
						$res = $TYPO3_DB->exec_SELECTquery ($fields, $tn, 'l18n_parent = '.$rid .' AND sys_language_uid='.$L. $where , '', $orderBy);
						$num=$TYPO3_DB->sql_num_rows($res);
					
					}
					if(!($num>0) || $L==0){
						$res = $TYPO3_DB->exec_SELECTquery ($fields, $tn, 'uid= '.$rid . $where, '', $orderBy);
					}
					
					while ($row = $TYPO3_DB->sql_fetch_assoc($res))	{
						if($tn=='tt_content'){
							$row['path'] = $this->getPath($row['CType'],$row['list_type']);
							if(strlen($row['pi_flexform'])>0){
								$row['pi_flexform'] = t3lib_div::xml2array($row['pi_flexform']);
							}else{
								unset($row['pi_flexform']);
							}
							if(strlen($row['bodytext'])>0){
								$row['bodytext'] = $this->parseText($row['bodytext'],$linkwrap);
							}
							if($row['header_link']){
								$row['header_link'] = $this->TS_links_rte($row['header_link'], $linkwrap);
							}
						
						}

						if($row['CType']=='shortcut' && $row['records'] ){
							if(!$infinity){
								//get linked records also
								$row['records'] = $this->getRecs($row['records'],$orderField,$L, $linkwrap,true);
							}else{
								$row['records'] = array('errortype'=>'2','errormsg'=>'Infinite linking in record "'.$row['uid']);
							}

						}
						$records[] = $row; 

					}

					//$records[] = $fields . ' '.$tn .' '.$rid .' '.$where . ' '. $orderBy;
					
				}
			}
		return $records;
	}
	
	function getRecsFromPage($tn='tt_content',$pid,$L=0,$linkwrap=''){
	
		global $FE_USER,$EXEC_TIME,$TCA,$TYPO3_DB;
		


		/*
		Check user access
		*/
		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}	
	
		$records = array();

		if($TCA==null){
			$this->getCompressedTCarray();
		}


	
				
		//get table name and check against TCA...

		if($TCA[$tn]){
			if($TCA[$tn]['columns'][$orderField]){
				$orderBy = $orderField;
			}else{
				$orderBy ='';
			}

			if($tn=='tt_content'){
				$fields = 'uid,CType,bodytext,fe_group,header,subheader,image,list_type,media,multimedia,pid,records,sys_language_uid,pi_flexform';
				$where = ' AND NOT deleted AND NOT hidden AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') '.$fe_access;

			}else{
				$fields ='*';
				$where = $this->deleteClause($tn) . $this->enableFields($tn);
			}
			//Added 10/10/2007
			if($L>0){
				$where .= ' AND sys_language_uid='.$L;
			
			}
			$res = $TYPO3_DB->exec_SELECTquery ($fields, $tn, 'pid= '.$pid . $where, '', $orderBy);
			
			while ($row = $TYPO3_DB->sql_fetch_assoc($res))	{
				if($tn=='tt_content'){
					$row['path'] = $this->getPath($row['CType'],$row['list_type']);
					if(strlen($row['pi_flexform'])>0){
						$row['pi_flexform'] = t3lib_div::xml2array($row['pi_flexform']);
					}else{
						unset($row['pi_flexform']);
					}

					if(strlen($row['bodytext'])>0){
						$row['bodytext'] = $this->parseText($row['bodytext'],$linkwrap);
					}
					if($row['header_link']){
						$row['header_link'] = $this->TS_links_rte($row['header_link'],$linkwrap);
					}
				}

				if($row['CType']=='shortcut' && $row['records'] ){
					if(!$infinity){
						//get linked records also
						$row['records'] = $this->getRecs($row['records'],$orderField,$L,$linkwrap,true);
					}else{
						$row['records'] = array('errortype'=>'2','errormsg'=>'Infinite linking in record "'.$row['uid']);
					}

				}
				$records[] = $row; 

			}

			
		}
		
		return $records;	
	}
	

	/*
	Security check
	*/
	function checkPrefix($rec,$prefixArr=array()){
		
		$pre = explode('_',$rec);
		$pre = $pre[0];
		if(in_array($pre,$prefixArr)){
			return true;
		}else{
			return false;
		}
	
	}

	function getTableName($str){
		//Find tableName as "tx_flashtemplate_content" in  "tx_flashtemplate_content_12"
		//$ditchMe = substr($str,-3,3);
		$ditchMe = strrchr($str,'_');
		if(strlen($ditchMe)>0){
			$arr = explode($ditchMe ,$str);
			return $arr[0];
		}else{
			return '';
		}
		
	//	return $tName;
	}
	
	function getRecordId($str){
		//Find recordId as last number of string, eg 12 in  "tx_flashtemplate_content_12"
		$arr = explode("_",$str);
		$recId = $arr[count($arr)-1];
		return $recId;
	}
	
	/*
	// Returns real paths for known uploads. Extend for your extensions as required. Maybe a TS config option would be useful, eg. that one can specify
	// upload path for one's extension.
	*/

	function getPath($ctype,$listtype){

		if($ctype == 'image'){
			return 'uploads/pics/';
		}else if($ctype == 'uploads'){
			return 'uploads/media/';
		}else if($ctype == 'textpic'){
			return 'uploads/pics/';
		}else if($ctype == 'multimedia'){
			return 'uploads/media/';
		}else if($ctype == 'list'){
			/*
			All plugins are listed as list.
			*/
			if(preg_match('/typoflash/',$listtype)){
				return 'uploads/tx_typoflash/';
			}else if(preg_match('/flashbg/',$listtype)){
				return 'uploads/tx_flashbg/';
			
			
			}
		
		}else{
			return '';
		}
	
	}

	function getLanguages($uid=0){
		
		global $TYPO3_DB;
		if($uid){
			
			$lstr = ' AND uid=' .$uid;	
		}else{
			$lstr = '';
		
		}
		$res = $TYPO3_DB->exec_SELECTquery('*', 'sys_language','hidden !=1' .$lstr );
		//return $res;
		$langArr = array();
		while($row = $TYPO3_DB->sql_fetch_assoc($res))	{
			//$stLrow = $this->getRawRecord('static_languages',$row['static_lang_isocode'],'lg_iso_2');
			$res1 = $TYPO3_DB->exec_SELECTquery('lg_iso_2', 'static_languages', 'uid='.intval($row['static_lang_isocode']));
			$stLrow = $TYPO3_DB->sql_fetch_assoc($res1);
			//return mysql_error();
			$row['isocode'] = $stLrow['lg_iso_2'];
			$row['path'] = 't3lib/gfx/flags/';
			$langArr[] = $row;
		}
		
		return $langArr;

	}

	/*
	
	This can be used to extract any linked record that should be nested in a lang array. Fields returned to be specified by array.
	*/
	
	function getRecordInLangArray($uid,$table,$fields=array(),$parseFields=array(),$wrap=''){
		global $BE_USER,$FE_USER,$EXEC_TIME,$TYPO3_DB,$TT,$TSFE;
		$res = $TYPO3_DB->exec_SELECTquery('*', $table,'uid='.$uid, '', '');
		$langArr = array('lang' => array());
		$row = $TYPO3_DB->sql_fetch_assoc($res);
		$l = array();
		$l['uid']= $row['uid'];
		foreach($row as $field=>$val){
			if(in_array($field,$fields)){
				$l[$field]= $val;
			}
			if(in_array($field,$parseFields)){
				$l[$field]= $this->parseText($val,$wrap);
			}
			
		}
	

		$langArr['lang'][0] = $l;

		$res = $TYPO3_DB->exec_SELECTquery('*', $table,'l18n_parent='.$uid, '', '');
		while($row = $TYPO3_DB->sql_fetch_assoc($res))	{
			$l = array();
			$l['uid']= $row['uid'];
			foreach($row as $field=>$val){
				if(in_array($field,$fields)){
					$l[$field]= $val;
				}
				if(in_array($field,$parseFields)){
					$l[$field]= $this->parseText($val,$wrap);
				}
			}

			$langArr['lang'][$row['sys_language_uid']] = $l;
		}
			
		return $langArr;
	}


	function getRenderedContent($pObj){

		//not finished with this yet...not sure how to use it

		$fRecs = $this->getRecs($pObj['records'],$pObj['orderBy'],$pObj['L'],$pObj['wrap']);
		$records = array();
		foreach($fRecs as $k=>$row){
			/*
			FAILED OR SEMIFAILED EFFORTS HERE
			*/
			//$cObj = t3lib_div::makeInstance('tslib_cObj');*/
			//$content = $cObj->TEXT(array('field' => 'bodytext','required' => 1,'parseFunc' => '< lib.parseFunc_RTE' ));//works but does nothing interesting!!!!!!!! But doesnt transform links
			//$content = $cObj->TEXT(array('field' => 'bodytext','stripHtml' => true)); //useful!!!
			//$content = $cObj->TEXT(array('field' => 'bodytext','makelinks'=>true,'parseFunc' => '< lib.parseFunc_RTE'));
			//$content = $cObj->http_makelinks($content,array());//this makes a search and replace
					
			//convert typolinks to real links
			//$row['bodytext'] = $this->TS_links_rte($row['bodytext'], $pObj['wrap']);
			//prepend relative paths with url
			//$row['bodytext'] = $this->makeAbsolutePaths($row['bodytext']);
			//$row['bodytext'] = $this->cleanHTML($row['bodytext']);
			
			//Moving these two into get recs so all bodytrext etc is extracted by default****************
			//$row['bodytext'] = $this->parseText($row['bodytext'],$pObj['wrap']);


			//if($row['header_link']){
			//	$row['header_link'] = $this->TS_links_rte($row['header_link'], $pObj['wrap']);
			//}

			//****************************************




			//$content = t3lib_BEfunc::getRecord('pages', $pObj['id']);
			//$content = $htmlParser->TS_AtagToAbs($content);
			$records[] = $row;
		}	

		$err = mysql_error(); 
		if($err==''){
			return array('result'=>$records,'callback'=>$pObj['callback']);
		}else {
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;
		}

		//$ceoConf = array('table' =>'tt_content','select.' => array('where' =>'uid='. $this->conf['reservation_email_record']));

		//output actual content
		//$htmlmessage =  $this->cObj->CONTENT($ceoConf) .
	}


	function parseText($txt,$wrap){
	
				//convert typolinks to real links
			$txt = $this->TS_links_rte($txt, $wrap);
			//prepend relative paths with url
			$txt = $this->makeAbsolutePaths($txt);
			$txt = $this->cleanHTML($txt);
			return $txt;
		
	}
	
/*
pages table:

Doktypes
1= standard
2 = advanced
3 = external shortcut
4 = internal shortcut
5 = not in menu
6 = 
7 = mount point
254 = sysfolder
255 = trash

shortcut points to other page
shortcut_mode:
0 = page itself
1 = first subpage
2 = random subpage (yeah right, very useful)

mount_pid = replace with subpage from here
mount_pid_ol = or with the page itself if this is set


By default you will want doktypes 1-4 + 7, and if L is sent the pageOverlay if there is one in that language. 

But we might as well use this function for BE editing as well, if you pass a doktype SQL clause ("AND doktype<200" or "AND doktype IN (1,2,7)"). Access control will be applied to that of course. To get the classic typo3 backend pagetree you need to send the "menuType=BEmenu". This means you want to get a page selector. The default is "menuType=FEmenu", which is a normal page menu.

Field you want can be specified as an array in the fields variable.

Preview options
if($pObj['showHiddenPage']){
	$hide = "";
}else{
	$hide =" AND hidden !=1"
}

if($pObj['showDeletedPage']){
	$delete = "";
}else{
	$delete =" AND deleted !=1"
}

if($pObj['showTimedPage']){
	$time = "";
}else{
	$time ="AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.')"
}
pages_language_overlay table:


Has starttime and endtime but not fe_group nor other be permissions

Remember that pid = 0 doesn't exist in the db

Caching
The menu is cached and retrieved from cache_hash unless no_cache is set
All remoting requests that have been cached share the same prefix identifier "REMOTING". Clearing the cache will only remove those values. No automatic expiry is set on caching.

No prevision has been made for denial of service attacks.


*/

	function getMenu($pObj=null){
		global $FE_USER,$EXEC_TIME,$TCA,$TYPO3_DB,$BE_USER;

		$pObj = (array) $pObj;//make sure swx objects are cast as array
		if(isset($pObj['fields']) || isset($pObj->fields)){
			$pObj['fields'] = (array) $pObj['fields'];	
		}
		
		/*
		04/07/2006
		In TYPO3 3.9 and up a field is added in pages table, nav_hide, which means page should be hidden.
		It is an alternative to no in menu type.

		So I need to figure out what version of TYPO3 it is and so on.

		This option is very useful for creating footer menus etc. The page itself with this option set
		will be hidden IF IT IS A SUBPAGE to another page. If the page has this flag but has visible subpages
		then they will still be rendered. Ie. it only applies when it is a subpage.
		*/

		if(intval($GLOBALS['TYPO_VERSION']>=3.9)){
			$checkForNavHide = true;
		}else{
			$checkForNavHide = false;
		}

		/*
		Set to FE menu by default
		*/
		if($pObj['menuType']==null){
			$pObj['menuType'] = 'FEmenu';
		}
		/*
		Check FE user access
		*/
		if(($FE_USER->user['uid']>0) && ($pObj['menuType']=='FEmenu')){
			//logged in
			
			if($FE_USER->user['usergroup']){
			//shoudl be in usergfroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else if(($pObj['menuType']=='FEmenu')){
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}else{
			//FE access is irrelevant for BE menus
			$fe_access ='';
		}		
		
		/*
		Check BE user access
		*/
		if(($pObj['menuType']!='FEmenu') && !($BE_USER->user['uid']>0)){
			$error = array('errortype'=>1,'errormsg'=>'No BE user logged in');
			return $error;
			die;
		}else if($pObj['menuType']=='BEmenu'){
			//$BE_USER->getPagePermsClause(1);
			//t3lib_BEfunc::readPageAccess($id,$perms_clause)// Returns a page record
			//t3lib_BEfunc::getRecord
			$be_access = $BE_USER->getPagePermsClause(1);
		
		}else {
			$be_access ='';
		}	
		

		/*
		First check if already cached
		Needs to consider login status
		*/
		$pObj['loginstatus'] = $fe_access.$be_access;
		if(!$pObj['no_cache']){
			$t = serialize($pObj);
			$hash = md5($t);
			$c = $this->getHash($hash,0);
			$menu = unserialize($c);
			if(is_array($menu)){
				return $menu;
				die;
			}
		}

		/*
		doktype options
		*/
		if($pObj['doktype']){
			$doktype = $pObj['doktype'];
		}else{
			$doktype = ' AND doktype IN (1,2,3,4,7)';
		
		}
		/*
		Preview options
		*/
		if($pObj['showHiddenPage']){
			$hide = '';
		}else{
			$hide =' AND hidden !=1';
		}

		if($checkForNavHide){
			$navhide = ' AND nav_hide!=1';
		}else{
			$navhide ='';
		}

		if($pObj['showDeletedPage']){
			$delete = '';
		}else{
			$delete =' AND deleted !=1';
		}

		if($pObj['showTimedPage']){
			$time = '';
		}else{
			$time =' AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.')';
		}


		/*
		Field options
		
		urltype 
		1 : http
		4 : https
		2 : ftp
		3 : mailto
		*/
		if(!(is_array($pObj['fields']))){
			$pObj['fields'] =array('uid','pid','title','storage_pid','sys_language_uid','nav_title','subtitle','url','urltype','target','media','description','author','abstract','alias','doktype','shortcut','shortcut_mode');
			//$pObj['fields'] =array('uid','pid','title');	
		}
		/*
		Page id options
		*/
		if(!($pObj['id']>0) && !(strlen($pObj['id'])>0)){
			$error = array('errortype'=>1,'errormsg'=>'No pid sent');
			return $error;
			die;
		}else if($pObj['id']>0){
			$page = 'uid='.intval($pObj['id']);
		}else{
			//alias sent
			$page = 'alias="'.$pObj['alias'].'"';
		}

		

		$access = $hide.$delete.$time.$be_access.$fe_access.$doktype;
		$where = $page .$access;

		//return $where;
		$res = $TYPO3_DB->exec_SELECTquery('*', 'pages', $where, '', 'sorting');
		$row = $TYPO3_DB->sql_fetch_assoc($res);
		$root_pid = $row['uid'];
		
		if(!($root_pid>0) && ($pObj['id']!=0)){
			//Didn't ask for root page with pid=0
			$error = array('errortype'=>1,'errormsg'=>'No page found with id '.$pObj['id'] );
			return $error;
			die;
		}


		/*
		Mountpoint options
		doktype = 7
		mount_pid = replace with subpage from here
		mount_pid_ol = or with the page itself if this is set
		*/

		if(($row['doktype']=='7') && $row['mount_pid'] && $row['mount_pid_ol'] ){
			$res = $TYPO3_DB->exec_SELECTquery('*', 'pages', 'uid=' . $row['mount_pid']. $access, '', 'sorting');
			$row = $TYPO3_DB->sql_fetch_assoc($res);
		}

		/*
		Language options
		*/
		if(is_int(intval($pObj['L'])) && $pObj['L']){
			//It's also different from zero
			$row = $this->getPageOverlay($row,intval($pObj['L']));
		}
		
		$temp = array();
		$temp['media_path'] = 'uploads/media/';
		foreach($pObj['fields'] as $k=>$v){
			 $temp[$v] = $row[$v];
		}

		if(($row['doktype']=='7') && $row['mount_pid']){
			//Append subpages from mountpoint
			$temp['subpages'] =  $this->getSubPages($row['mount_pid'],intval($pObj['L']),$pObj['fields'],$access.$navhide);
		}else {
			$temp['subpages'] = $this->getSubPages($root_pid,intval($pObj['L']),$pObj['fields'],$access.$navhide);
		}
	
		$menu = $temp;
		
		/*
		Return menuId so that flash can identify which menu is incoming
		*/
		$menu['menuId'] = $pObj['menuId'];

		
		/*
		Save to cache
		*/
		if($pObj['no_cache']){
			//Wasn't done above if so
			$t = serialize($pObj);
			$hash = md5($t);
		}
		$data = serialize($menu);
		$this->storeHash($hash,$data,'REMOTING_menu');
		
		
		unset($pObj['fields']);
		$menu['pObj'] = $pObj;
		return $menu;
	
	}
	
	function getSubPages($uid,$L,$fields,$access){
		global $TYPO3_DB;
		if($uid == null){
			return array();
		}
		$where = 'pid='.$uid . $access;
		$menu = array();
		//$menu['associate']='array';
		$res = array();
		$res[0] = $TYPO3_DB->exec_SELECTquery('*', 'pages', $where, '', 'sorting');
		while ($row = $TYPO3_DB->sql_fetch_assoc($res[0]))	{
			/*
			Mountpoint options
			doktype = 7
			mount_pid = replace with subpage from here
			mount_pid_ol = or with the page itself if this is set
			*/
			unset($r);
			if(($row['doktype']=='7') && $row['mount_pid'] && $row['mount_pid_ol'] ){
				$res[$row['uid']] = $TYPO3_DB->exec_SELECTquery('*', 'pages', 'uid=' . $row['mount_pid']. $access, '', 'sorting');//Need a unique variable name so as not to overwrite previous recordset
				$r = $TYPO3_DB->sql_fetch_assoc($res[$row['uid']]);
				if(!($r['uid'])){
					//If we haven't got a proper page of the type we searched for continue
					//Eg when a sysfolder is mounted and ticked to replace other page
					continue;
				}
			}
			
			if(!isset($r)){

				//Replace with mounted row if found. If you replace row itself the while statement will break
				$r = $row;
			}
			
			/*
			Language options
			*/
			if($L>0){
				//It's also different from zero
				$r = $this->getPageOverlay($r,$L);
			}
			
			$temp = array();
			$temp['media_path'] = 'uploads/media/';
			foreach($fields as $k=>$v){
				 $temp[$v] = $r[$v];
			}
			
			if(($r['doktype']=='7') && $r['mount_pid']){
				//Append subpages from mountpoint
				$temp['subpages'] =  $this->getSubPages($r['mount_pid'],$L,$fields,$access);
			
			}else {
				$temp['subpages'] = $this->getSubPages($r['uid'],$L,$fields,$access);

			}
			if($temp['uid'] >0){
				//Only add if some content found
				$menu[] = $temp;
			}
			
		}
		return $menu;
	
	
	}
	

	/*
	We want this to return a lookup table indexed on the uid of the page.
	
	*/
	
	function addToMotherload($uid,$L,$fields,$access){
		global $TYPO3_DB;
		if($uid == null){
			return array();
		}
		$where = 'pid='.$uid . $access;
		//$menu = array();
		//$menu['associate']='array';
		$res = array();
		$mRes = $TYPO3_DB->exec_SELECTquery('*', 'pages', $where, '', 'sorting');
		while ($row = $TYPO3_DB->sql_fetch_assoc($mRes))	{
			/*
			Mountpoint options
			doktype = 7
			mount_pid = replace with subpage from here
			mount_pid_ol = or with the page itself if this is set
			*/
			unset($r);
			if(($row['doktype']=='7') && $row['mount_pid'] && $row['mount_pid_ol'] ){
				$res[$row['uid']] = $TYPO3_DB->exec_SELECTquery('*', 'pages', 'uid=' . $row['mount_pid']. $access, '', 'sorting');//Need a unique variable name so as not to overwrite previous recordset
				$r = $TYPO3_DB->sql_fetch_assoc($res[$row['uid']]);
				if(!($r['uid'])){
					//If we haven't got a proper page of the type we searched for continue
					//Eg when a sysfolder is mounted and ticked to replace other page
					continue;
				}
			}
			
			if(!isset($r)){

				//Replace with mounted row if found. If you replace row itself the while statement will break
				$r = $row;
			}
			
			/*
			Language options
			*/
			if($L>0){
				//It's also different from zero
				$r = $this->getPageOverlay($r,$L);
			}
			
			/*
			
			*/
			$temp = array();
			$temp['media_path'] = 'uploads/media/';
			foreach($fields as $k=>$v){
				 $temp[$v] = $r[$v];
			}
			
			if(($r['doktype']=='7') && $r['mount_pid']){
				//Append subpages from mountpoint
				//$menu = array_merge($menu,$this->addToMotherload($r['mount_pid'],$L,$fields,$access));
				$this->addToMotherload($r['mount_pid'],$L,$fields,$access);
			
			}else {
				//Get all subpages to this page
				//$menu = array_merge($menu,$this->addToMotherload($r['uid'],$L,$fields,$access));
				$this->addToMotherload($r['uid'],$L,$fields,$access);

			}
			if($temp['uid']>0){
				//Only add if some content found
				$this->motherload[$temp['uid']] = $temp;//this really just maps uid to uid in this case
			}
			
		}
		//return $menu;
	
	
	}

		/**
	 * Returns the relevant page overlay record fields
	 *
	 * @param	mixed		If $pageInput is an integer, it's the pid of the pageOverlay record and thus the page overlay record is returned. If $pageInput is an array, it's a page-record and based on this page record the language record is found and OVERLAYED before the page record is returned.
	 * @param	integer		Language UID if you want to set an alternative value to $this->sys_language_uid which is default. Should be >=0
	 * @return	array		Page row which is overlayed with language_overlay record (or the overlay record alone)
	 */
	function getPageOverlay($org_row,$L=0)	{
		global $TYPO3_DB;
		//$ofields='sys_language_uid,pid,title,nav_title,subtitle,media,description,abstract,author';

			// Selecting overlay record:
		$res = $TYPO3_DB->exec_SELECTquery(
					'*',
					'pages_language_overlay',
					'pid='.intval($org_row['uid']).' AND sys_language_uid='.intval($L),
					'',
					'',
					'1'
				);
		$row = $TYPO3_DB->sql_fetch_assoc($res);
		if (is_array($row))	{
				// Unset vital fields that are NOT allowed to be overlaid:
			unset($row['uid']);
			unset($row['pid']);
		}

		return is_array($row) ? array_merge($org_row,$row) : $org_row;	// If the input was an array, simply overlay the newfound array and return...
	}












	/*********************************
	 *
	 * Caching and standard clauses
	 *
	 **********************************/

	/**
	 * Returns string value stored for the hash string in the table "cache_hash"
	 * Can be used to retrieved a cached value
	 * Can be used from your frontend plugins if you like. Is also used to store the parsed TypoScript template structures. You can call it directly like t3lib_pageSelect::getHash()
	 *
	 * @param	string		The hash-string which was used to store the data value
	 * @param	integer		Allowed expiretime in seconds. Basically a record is selected only if it is not older than this value in seconds. If expTime is not set, the hashed value will never expire.
	 * @return	string		The "content" field of the "cache_hash" table row.
	 * @see tslib_TStemplate::start(), storeHash()
	 */
	function getHash($hash,$expTime=0)	{
			//
		$expTime = intval($expTime);
		if ($expTime)	{
			$whereAdd = ' AND tstamp > '.(time()-$expTime);
		}
		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('content', 'cache_hash', 'hash="'.$GLOBALS['TYPO3_DB']->quoteStr($hash, 'cache_hash').'"'.$whereAdd);
		if ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{
			$GLOBALS['TYPO3_DB']->sql_free_result($res);
			return $row['content'];
		}
	}

	/**
	 * Stores a string value in the cache_hash table identified by $hash.
	 * Can be used from your frontend plugins if you like. You can call it directly like t3lib_pageSelect::storeHash()
	 *
	 * @param	string		32 bit hash string (eg. a md5 hash of a serialized array identifying the data being stored)
	 * @param	string		The data string. If you want to store an array, then just serialize it first.
	 * @param	string		$ident is just a textual identification in order to inform about the content! May be 20 characters long.
	 * @return	void
	 * @see tslib_TStemplate::start(), getHash()
	 */
	function storeHash($hash,$data,$ident)	{
		$insertFields = array(
			'hash' => $hash,
			'content' => $data,
			'ident' => $ident,
			'tstamp' => time()
		);
		$GLOBALS['TYPO3_DB']->exec_DELETEquery('cache_hash', 'hash="'.$GLOBALS['TYPO3_DB']->quoteStr($hash, 'cache_hash').'"');
		$GLOBALS['TYPO3_DB']->exec_INSERTquery('cache_hash', $insertFields);
	}

	function clearCache(){
		$GLOBALS['TYPO3_DB']->exec_DELETEquery('cache_hash', 'ident LIKE "REMOTING%"');
		
		$err =mysql_error(); 
		if($err==''){
			return true;
		}else {
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;

		}

	}






	/**
	 * Returns the "AND NOT deleted" clause for the tablename given IF $TCA configuration points to such a field.
	 *
	 * @param	string		Tablename
	 * @return	string
	 * @see enableFields()
	 */
	function deleteClause($table)	{
		global $TCA;
		if (!strcmp($table,'pages'))	{	// Hardcode for pages...:
			return ' AND deleted=0';
		} else {
			return $TCA[$table]['ctrl']['delete'] ? ' AND '.$TCA[$table]['ctrl']['delete'].'=0' : '';
		}
	}



	/**
	 * Returns a part of a WHERE clause which will filter out records with start/end times or hidden/fe_groups fields set to values that should de-select them according to the current time, preview settings or user login. Definitely a frontend function.
	 * Is using the $TCA arrays "ctrl" part where the key "enablefields" determines for each table which of these features applies to that table.
	 *
	 * @param	string		Table name found in the $TCA array
	 * @param	integer		If $show_hidden is set (0/1), any hidden-fields in records are ignored. NOTICE: If you call this function, consider what to do with the show_hidden parameter. Maybe it should be set? See tslib_cObj->enableFields where it's implemented correctly.
	 * @param	array		Array you can pass where keys can be "disabled", "starttime", "endtime", "fe_group" (keys from "enablefields" in TCA) and if set they will make sure that part of the clause is not added. Thus disables the specific part of the clause. For previewing etc.
	 * @return	string		The clause starting like " AND ...=... AND ...=..."
	 * @see tslib_cObj::enableFields(), deleteClause()
	 */
	function enableFields($table,$show_hidden=-1,$ignore_array=array())	{
		if ($show_hidden==-1 && $this->showHiddenPage)	{	
			$show_hidden = 1;
		}
		if ($show_hidden==-1)	$show_hidden=0;	// If show_hidden was not changed during the previous evaluation, do it here.

		$ctrl = $GLOBALS['TCA'][$table]['ctrl'];
		$query='';
		if (is_array($ctrl))	{
			if ($ctrl['delete'])	{
				$query.=' AND '.$table.'.'.$ctrl['delete'].'=0';
			}
			if (is_array($ctrl['enablecolumns']))	{
				if ($ctrl['enablecolumns']['disabled'] && !$show_hidden && !$ignore_array['disabled'])	{
					$field = $table.'.'.$ctrl['enablecolumns']['disabled'];
					$query.=' AND '.$field.'=0';
				}
				if ($ctrl['enablecolumns']['starttime'] && !$ignore_array['starttime'])	{
					$field = $table.'.'.$ctrl['enablecolumns']['starttime'];
					$query.=' AND ('.$field.'<='.$GLOBALS['SIM_EXEC_TIME'].')';
				}
				if ($ctrl['enablecolumns']['endtime'] && !$ignore_array['endtime'])	{
					$field = $table.'.'.$ctrl['enablecolumns']['endtime'];
					$query.=' AND ('.$field.'=0 OR '.$field.'>'.$GLOBALS['SIM_EXEC_TIME'].')';
				}
				/*if ($ctrl['enablecolumns']['fe_group'] && !$ignore_array['fe_group'])	{
					$field = $table.'.'.$ctrl['enablecolumns']['fe_group'];
					$gr_list = $GLOBALS['TSFE']->gr_list;
					if (!strcmp($gr_list,''))	$gr_list=0;
					$query.=' AND '.$field.' IN ('.$gr_list.')';
				}*/
			}
		} else {
			//No info found
			$query.='';
		}

		return $query;
	}




	/**
	 * Get the compressed $TCA array for use in the front-end
	 * A compressed $TCA array holds only the ctrl- and feInterface-part for each table. But the column-definitions are omitted in order to save some memory and be more efficient.
	 * Operates on the global variable, $TCA
	 *
	 * @return	void
	 * @see includeTCA()
	 */
	function getCompressedTCarray()	{ 
		global $TCA;

		if (!$this->TCAloaded)	{
				// Create hash string for storage / retrieval of cached content:
			$tempHash = md5('tables.php:'.
				filemtime(TYPO3_extTableDef_script ? PATH_typo3conf.TYPO3_extTableDef_script : PATH_t3lib.'stddb/tables.php').
				(TYPO3_extTableDef_script?filemtime(PATH_typo3conf.TYPO3_extTableDef_script):'').
				($GLOBALS['TYPO3_LOADED_EXT']['_CACHEFILE'] ? filemtime(PATH_typo3conf.$GLOBALS['TYPO3_LOADED_EXT']['_CACHEFILE'].'_ext_tables.php') : '')
			);
				// Try to fetch if:
			list($TCA,$this->TCAcachedExtras) = unserialize($this->getHash($tempHash, 0));
				// If no result, create it:
			if (!is_array($TCA))	{
				$this->includeTCA(0);
				$newTc = Array();
				$this->TCAcachedExtras = array();	// Collects other information

				foreach($TCA as $key => $val)		{
					$newTc[$key]['ctrl'] = $val['ctrl'];
					$newTc[$key]['feInterface'] = $val['feInterface'];

						// Collect information about localization exclusion of fields:
					t3lib_div::loadTCA($key);
					if (is_array($TCA[$key]['columns']))	{
						$this->TCAcachedExtras[$key]['l10n_mode'] = array();
						foreach($TCA[$key]['columns'] as $fN => $fV)	{
							if ($fV['l10n_mode'])	{
								$this->TCAcachedExtras[$key]['l10n_mode'][$fN] = $fV['l10n_mode'];
							}
						}
					}
				}

					// Store it in cache:
				$TCA = $newTc;
				$this->storeHash($tempHash, serialize(array($newTc,$this->TCAcachedExtras)), 'SHORT TC');
			}
		}

	}



	/**
	 * Includes full TCA.
	 * Normally in the frontend only a part of the global $TCA array is loaded, for instance the "ctrl" part. Thus it doesn't take up too much memory.
	 * If you need the FULL TCA available for some reason (like plugins using it) you should call this function which will include the FULL TCA.
	 * Global vars $TCA, $PAGES_TYPES, $LANG_GENERAL_LABELS can/will be affected.
	 * The flag $this->TCAloaded will make sure that such an inclusion happens only once since; If $this->TCAloaded is set, nothing is included.
	 *
	 * @param	boolean		Probably, keep hands of this value. Just don't set it. (This may affect the first-ever time this function is called since if you set it to zero/false any subsequent call will still trigger the inclusion; In other words, this value will be set in $this->TCAloaded after inclusion and therefore if its false, another inclusion will be possible on the next call. See ->getCompressedTCarray())
	 * @return	void
	 * @see getCompressedTCarray()
	 */
	function includeTCA($TCAloaded=1)	{
		global $TCA, $PAGES_TYPES, $LANG_GENERAL_LABELS, $TBE_MODULES;
		if (!$this->TCAloaded)	{
			$TCA = Array();
			include (TYPO3_tables_script ? PATH_typo3conf.TYPO3_tables_script : PATH_t3lib.'stddb/tables.php');
				// Extension additions
			if ($GLOBALS['TYPO3_LOADED_EXT']['_CACHEFILE'])	{
				include(PATH_typo3conf.$GLOBALS['TYPO3_LOADED_EXT']['_CACHEFILE'].'_ext_tables.php');
			} else {
				include(PATH_t3lib.'stddb/load_ext_tables.php');
			}
				// ext-script
			if (TYPO3_extTableDef_script)	{
				include (PATH_typo3conf.TYPO3_extTableDef_script);
			}

			$this->TCAloaded = $TCAloaded;
		}
	}

//from t3lib_page
	
	/**
	 * Returns array with fields of the pages from here ($uid) and back to the root
	 * NOTICE: This function only takes deleted pages into account! So hidden, starttime and endtime restricted pages are included no matter what.
	 * Further: If any "recycler" page is found (doktype=255) then it will also block for the rootline)
	 * If you want more fields in the rootline records than default such can be added by listing them in $GLOBALS['TYPO3_CONF_VARS']['FE']['addRootLineFields']
	 *
	 * @param	integer		The page uid for which to seek back to the page tree root.
	 * @param	string		Commalist of MountPoint parameters, eg. "1-2,3-4" etc. Normally this value comes from the GET var, MP
	 * @param	boolean		If set, some errors related to Mount Points in root line are ignored.
	 * @return	array		Array with page records from the root line as values. The array is ordered with the outer records first and root record in the bottom. The keys are numeric but in reverse order. So if you traverse/sort the array by the numeric keys order you will get the order from root and out. If an error is found (like eternal looping or invalid mountpoint) it will return an empty array.
	 * @see tslib_fe::getPageAndRootline()
	 */
	function getRootLine($uid, $MP='', $ignoreMPerrors=FALSE,$L=0)	{
		
			// Initialize:
		$selFields = t3lib_div::uniqueList('pid,uid,t3ver_oid,title,alias,nav_title,media,layout,hidden,starttime,endtime,fe_group,extendToSubpages,doktype,TSconfig,storage_pid,is_siteroot,mount_pid,mount_pid_ol,'.$GLOBALS['TYPO3_CONF_VARS']['FE']['addRootLineFields']);
		$this->error_getRootLine = '';
		$this->error_getRootLine_failPid = 0;

			// Splitting the $MP parameters if present
		$MPA = array();
		if ($MP)	{
			$MPA = explode(',',$MP);
			reset($MPA);
			while(list($MPAk) = each($MPA))	{
				$MPA[$MPAk] = explode('-', $MPA[$MPAk]);
			}
		}
		
		$loopCheck = 0;
		$theRowArray = Array();
		$uid = intval($uid);

		while ($uid!=0 && $loopCheck<20)	{	// Max 20 levels in the page tree.
			$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery($selFields, 'pages', 'uid='.intval($uid).' AND pages.deleted=0 AND pages.doktype!=255');
			if ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{
				//$this->fixVersioningPid('pages',$row);
#??				$this->versionOL('pages',$row);

					// Mount Point page types are allowed ONLY a) if they are the outermost record in rootline and b) if the overlay flag is not set:
				if ($GLOBALS['TYPO3_CONF_VARS']['FE']['enable_mount_pids'] && $row['doktype']==7 && !$ignoreMPerrors)	{
					$mount_info = $this->getMountPointInfo($row['uid'], $row);
					if ($loopCheck>0 || $mount_info['overlay'])	{
						$this->error_getRootLine = 'Illegal Mount Point found in rootline';
						return array();
					}
				}

				$uid = $row['pid'];	// Next uid

				if (count($MPA) && $GLOBALS['TYPO3_CONF_VARS']['FE']['enable_mount_pids'])	{
					$curMP = end($MPA);
					if (!strcmp($row['uid'],$curMP[0]))	{

						array_pop($MPA);
						$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery($selFields, 'pages', 'uid='.intval($curMP[1]).' AND pages.deleted=0 AND pages.doktype!=255');
						$mp_row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res);

						if (is_array($mp_row))	{
							//$this->fixVersioningPid('pages',$mp_row);
#??							$this->versionOL('pages',$mp_row);
							$mount_info = $this->getMountPointInfo($mp_row['uid'], $mp_row);
							if (is_array($mount_info) && $mount_info['mount_pid']==$curMP[0])	{
								$uid = $mp_row['pid'];	// Setting next uid

								if ($mount_info['overlay'])	{	// Symlink style: Keep mount point (current row).
									$row['_MOUNT_OL'] = TRUE;	// Set overlay mode:
									$row['_MOUNT_PAGE'] = array(
										'uid' => $mp_row['uid'],
										'pid' => $mp_row['pid'],
										'title' =>  $mp_row['title'],
									);
								} else {	// Normal operation: Insert the mount page row in rootline instead mount point.
									if ($loopCheck>0)	{
										$row = $mp_row;
									} else {
										$this->error_getRootLine = 'Current Page Id is a mounted page of the overlay type and cannot be accessed directly!';
										return array();	// Matching the page id (first run, $loopCheck = 0) with the MPvar is ONLY allowed if the mount point is the "overlay" type (otherwise it could be forged!)
									}
								}

								$row['_MOUNTED_FROM'] = $curMP[0];
								$row['_MP_PARAM'] = $mount_info['MPvar'];
							} else {
								$this->error_getRootLine = 'MP var was corrupted';
								return array();	// The MP variables did NOT connect proper mount points:
							}
						} else {
							$this->error_getRootLine = 'No moint point record found according to PID in MP var';
							return array();	// The second PID in MP var was NOT a valid page.
						}
					}
				}
					// Add row to rootline with language overlaid:
				$theRowArray[] = $this->getPageOverlay($row,$L);
			} else {
				$this->error_getRootLine = 'Broken rootline';
				$this->error_getRootLine_failPid = $uid;
				return array();	// broken rootline.
			}

			$loopCheck++;
		}

			// If the MPA array is NOT empty, we have to return an error; All MP elements were not resolved!
		if (count($MPA))	{
			$this->error_getRootLine = 'MP value remain!';
			return array();
		}

			// Create output array (with reversed order of numeric keys):
		$output = Array();
		$c = count($theRowArray);
		foreach($theRowArray as $key => $val)	{
			$c--;
			$output[$c] = $val;
		}

		return $output;
	}

/**
	 * Returns MountPoint id for page
	 * Does a recursive search if the mounted page should be a mount page itself. It has a run-away break so it can't go into infinite loops.
	 *
	 * @param	integer		Page id for which to look for a mount pid. Will be returned only if mount pages are enabled, the correct doktype (7) is set for page and there IS a mount_pid (which has a valid record that is not deleted...)
	 * @param	array		Optional page record for the page id. If not supplied it will be looked up by the system. Must contain at least uid,pid,doktype,mount_pid,mount_pid_ol
	 * @param	array		Array accumulating formerly tested page ids for mount points. Used for recursivity brake.
	 * @param	integer		The first page id.
	 * @return	mixed		Returns FALSE if no mount point was found, "-1" if there should have been one, but no connection to it, otherwise an array with information about mount pid and modes.
	 * @see tslib_menu
	 */
	function getMountPointInfo($pageId, $pageRec=FALSE, $prevMountPids=array(), $firstPageUid=0)	{
		if ($GLOBALS['TYPO3_CONF_VARS']['FE']['enable_mount_pids'])	{

				// Get pageRec if not supplied:
			if (!is_array($pageRec))	{
				$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('uid,pid,doktype,mount_pid,mount_pid_ol', 'pages', 'uid='.intval($pageId).' AND pages.deleted=0 AND pages.doktype!=255');
				$pageRec = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res);
#??				$this->versionOL('pages',$pageRec);
			}

				// Set first Page uid:
			if (!$firstPageUid)	$firstPageUid = $pageRec['uid'];

				// Look for mount pid value plus other required circumstances:
			$mount_pid = intval($pageRec['mount_pid']);
			if (is_array($pageRec) && $pageRec['doktype']==7 && $mount_pid>0 && !in_array($mount_pid, $prevMountPids))	{

					// Get the mount point record (to verify its general existence):
				$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('uid,pid,doktype,mount_pid,mount_pid_ol', 'pages', 'uid='.$mount_pid.' AND pages.deleted=0 AND pages.doktype!=255');
				$mount_rec = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res);
				if (is_array($mount_rec))	{
#??					$this->versionOL('pages',$mount_rec);

						// Look for recursive mount point:
					$prevMountPids[] = $mount_pid;
					$recursiveMountPid = $this->getMountPointInfo($mount_pid, $mount_rec, $prevMountPids, $firstPageUid);

						// Return mount point information:
					return $recursiveMountPid ?
								$recursiveMountPid :
								array(
									'mount_pid' => $mount_pid,
									'overlay' => $pageRec['mount_pid_ol'],
									'MPvar' => $mount_pid.'-'.$firstPageUid,
									'mount_point_rec' => $pageRec,
									'mount_pid_rec' => $mount_rec,
								);
				} else {
					return -1;	// Means, there SHOULD have been a mount point, but there was none!
				}
			}
		}

		return FALSE;
	}










	/*
	Strip props of object
	dontTOuch is array. Some fields seem not to be configured properly in TCA.
	*/

	function unsetNonDBfields($table,$obj,$dontTouch=array()){
		global $TCA;
		$this->getCompressedTCarray();
		//Get fields in database
		t3lib_div::loadTCA($table);
		
		foreach($obj as $k=>$v){
			if(!array_key_exists($k, $GLOBALS['TCA'][$table]['columns']) && !in_array($k,$dontTouch)){
				unset($obj[$k]);
			}
		}

		return $obj;
	
	}



/*
From t3lib_TStemplate

Modified for remoting
*/

	function getTSsetup($pObj=null,$piKey=null){
		if($pObj==null){
			return;
		}
		if($GLOBALS['TSFE']->tmpl==null){
			$GLOBALS['TSFE'] = t3lib_div::makeInstance('contentrendering'); ;
			$GLOBALS['TSFE']->id = $pObj['id'];
			$GLOBALS['TSFE']->MP = $pObj['MP'];
			$GLOBALS['TSFE']->sys_language_uid = $pObj['L'];
			$GLOBALS['TSFE']->tmpl = t3lib_div::makeInstance('t3lib_TStemplate');
			$GLOBALS['TSFE']->tmpl->init();
			$GLOBALS['TSFE']->sys_page = t3lib_div::makeInstance('t3lib_pageSelect');
			$rootLine = $this->getRootLine($pObj['id'], $pObj['MP'],false,$pObj['L']);
			$GLOBALS['TSFE']->tmpl->start($rootLine);
		}
		if($piKey ==null){
			return $GLOBALS['TSFE']->tmpl->setup;
		}else{
			return $GLOBALS['TSFE']->tmpl->setup['plugin.'][$piKey.'.'];
		}
	}










/*
From tslib_fe.php
*/


	/**
	 * Substitute function for the PHP mail() function.
	 * It will encode the email with the setting of TS 'config.notification_email_encoding' (base64 or none)
	 * It will also find all links to http:// in the text and substitute with a shorter link using the redirect feature which stores the long link in the database. Depends on configuration in TS 'config.notification_email_urlmode'
	 *
	 * @param	string		recipient email address (or list of)
	 * @param	string		The subject
	 * @param	string		The message
	 * @param	string		The headers (string with lines)
	 * @return	void
	 * @see t3lib_div::plainMailEncoded()
	 */
	function plainMailEncoded($email,$subject,$message,$headers='',$enc='8bit',$charset='ISO-8859-1',$urlmode=null)	{

		if ($urlmode)	{
			$message=t3lib_div::substUrlsInPlainText($message,$urlmode);
		}

		t3lib_div::plainMailEncoded(
			$email,
			$subject,
			$message,
			$headers,
			$enc,
			$charset
		);
	}

		
		/**
		* Invokes the HTML mailing class
		*
		* @param string  $HTMLContent: HTML version of the message
		* @param string  $PLAINContent: plain version of the message
		* @param string  $recipient: email address
		* @param string  $dummy: ''
		* @param string  $fromEmail: email address
		* @param string  $fromName: name
		* @param string  $replyTo: email address
		* @param string  $fileAttachment: file name
		* @return void
		*/
		function sendHTMLMail($HTMLContent, $PLAINContent, $recipient, $subject, $fromEmail, $fromName, $replyTo = '', $fileAttachment = '') {
			// HTML
			if (trim($recipient)) {
				$parts = spliti('<title>|</title>', $HTMLContent, 3);
					 
				$Typo3_htmlmail = t3lib_div::makeInstance('t3lib_htmlmail');
				$Typo3_htmlmail->start();
				$Typo3_htmlmail->mailer = 'Typo3 HTMLMail';
				$Typo3_htmlmail->subject = $subject;
				$Typo3_htmlmail->from_email = $fromEmail;
				$Typo3_htmlmail->returnPath = $fromEmail;
				$Typo3_htmlmail->from_name = $fromName;
				$Typo3_htmlmail->from_name = implode(' ' , t3lib_div::trimExplode(',', $Typo3_htmlmail->from_name));
				$Typo3_htmlmail->replyto_email = $replyTo ? $replyTo :$fromEmail;
				$Typo3_htmlmail->replyto_name = $replyTo ? '' : $fromName;
				$Typo3_htmlmail->replyto_name = implode(' ' , t3lib_div::trimExplode(',', $Typo3_htmlmail->replyto_name));
				$Typo3_htmlmail->organisation = '';
				$Typo3_htmlmail->priority = 3;
				 
				// ATTACHMENT
				if ($fileAttachment && file_exists($fileAttachment)) {
					$Typo3_htmlmail->addAttachment($fileAttachment);
				}
				 
				// HTML
				if (trim($HTMLContent)) {
					$Typo3_htmlmail->theParts['html']['content'] = $HTMLContent;
					$Typo3_htmlmail->theParts['html']['path'] = '';
					$Typo3_htmlmail->extractMediaLinks();
					$Typo3_htmlmail->extractHyperLinks();
					$Typo3_htmlmail->fetchHTMLMedia();
					$Typo3_htmlmail->substMediaNamesInHTML(0); // 0 = relative
					$Typo3_htmlmail->substHREFsInHTML();
					 
					$Typo3_htmlmail->setHTML($Typo3_htmlmail->encodeMsg($Typo3_htmlmail->theParts['html']['content']));
				}
				// PLAIN
				$Typo3_htmlmail->addPlain($PLAINContent);
				// SET Headers and Content
				$Typo3_htmlmail->setHeaders();
				$Typo3_htmlmail->setContent();
				$Typo3_htmlmail->setRecipient($recipient);
				$Typo3_htmlmail->sendtheMail();
			}
		}
	/**
	 * Converts the charset of the input string if applicable.
	 * The "from" charset is determined by the TYPO3 system charset for the current language key ($this->lang)
	 * The "to" charset is determined by the currently used charset for the page which is "iso-8859-1" by default or set by $GLOBALS['TSFE']->config['config']['metaCharset']
	 * Only if there is a difference between the two charsets will a conversion be made
	 * The conversion is done real-time - no caching for performance at this point!
	 *
	 * @param	string		String to convert charset for
	 * @param	string		Optional "from" charset.
	 * @return	string		Output string, converted if needed.
	 * @see t3lib_cs
	 */
	function csConv($str,$from='')	{
		$this->csConvObj = t3lib_div::makeInstance('t3lib_cs');
		if ($from)	{
			$output = $this->csConvObj->conv($str,$this->csConvObj->parse_charset($from),$this->renderCharset,1);
			return $output ? $output : $str;
		} elseif (is_array($this->convCharsetToFrom))	{
			return $this->csConvObj->conv($str,$this->convCharsetToFrom['from'],$this->convCharsetToFrom['to'],1);
		} else {
			return $str;
		}
	}

	/**
	 * Converts input string from renderCharset to metaCharset IF the two charsets are different.
	 *
	 * @param	string		Content to be converted.
	 * @param	string		Label (just for fun, no function)
	 * @return	string		Converted content string.
	 */
	function convOutputCharset($content,$label)	{
		if ($this->renderCharset != $this->metaCharset)	{
			$content = $this->csConvObj->conv($content,$this->renderCharset,$this->metaCharset,TRUE);
		}

		return $content;
	}

	/**
	 * Converts the $_POST array from metaCharset (page HTML charset from input form) to renderCharset (internal processing) IF the two charsets are different.
	 *
	 * @return	void
	 */
	function convPOSTCharset()	{
		if ($this->renderCharset != $this->metaCharset && is_array($_POST) && count($_POST))	{
			$this->csConvObj->convArray($_POST,$this->metaCharset,$this->renderCharset);
			$GLOBALS['HTTP_POST_VARS'] = $_POST;
		}
	}




/*
From tslib_pibase

*/





	/***************************
	 *
	 * Localization, locallang functions
	 *
	 **************************/


	/**
	 * Returns the localized label of the LOCAL_LANG key, $key
	 * Notice that for debugging purposes prefixes for the output values can be set with the internal vars ->LLtestPrefixAlt and ->LLtestPrefix
	 *
	 * @param	string		The key from the LOCAL_LANG array for which to return the value.
	 * @param	string		Alternative string to return IF no value is found set for the key, neither for the local language nor the default.
	 * @param	boolean		If true, the output label is passed through htmlspecialchars()
	 * @return	string		The value from LOCAL_LANG.
	 */
	function pi_getLL($pObj,$key,$alt='',$hsc=FALSE)	{

		if($pObj['L']>0){
			$L = $this->getLanguages($pObj['L']);
			if($L[0]['isocode']){
					$this->LLkey = 	strtolower($L[0]['isocode']);
			}
		
		}else{
			$this->LLkey = 	'default';
		}


		if (isset($this->LOCAL_LANG[$this->LLkey][$key]))	{
			$word = $this->csConv($this->LOCAL_LANG[$this->LLkey][$key]);
		} elseif (isset($this->LOCAL_LANG['default'][$key]))	{
			$word = $this->LOCAL_LANG['default'][$key];
		} else {
			$word = $this->LLtestPrefixAlt.$alt;
		}

		$output = $this->LLtestPrefix.$word;
		if ($hsc)	$output = htmlspecialchars($output);

		return $output;
	}

	/**
	 * Loads local-language values by looking for a "locallang.php" file in the plugin class directory ($this->scriptRelPath) and if found includes it.
	 * Also locallang values set in the TypoScript property "_LOCAL_LANG" are merged onto the values found in the "locallang.php" file.
	 * Since, remoting is executed through gateway.php the path is different. Need to prepend with PATH_site to get file.
	 * By default, it will look for locallang.php in the remoting directory. If you wish to share lang with the corresponding plugin, specify 
	 * the file instead.
	 * @return	void
	 */
	function pi_loadLL($file=null)	{
		if (!$this->LOCAL_LANG_loaded && $this->scriptRelPath &&!$file)	{
			$basePath = PATH_site . t3lib_extMgm::siteRelPath($this->extKey).dirname($this->scriptRelPath).'/locallang.php';
			if (@is_file($basePath))	{
				include('./'.$basePath);
				$this->LOCAL_LANG = $LOCAL_LANG;
				if (is_array($this->conf['_LOCAL_LANG.']))	{
					reset($this->conf['_LOCAL_LANG.']);
					while(list($k,$lA)=each($this->conf['_LOCAL_LANG.']))	{
						if (is_array($lA))	{
							$k = substr($k,0,-1);
							$this->LOCAL_LANG[$k] = t3lib_div::array_merge_recursive_overrule(is_array($this->LOCAL_LANG[$k])?$this->LOCAL_LANG[$k]:array(), $lA);
						}
					}
				}
			}
		}else if(!$this->LOCAL_LANG_loaded && $file){
			if (@is_file($file))	{
				include($file);
				$this->LOCAL_LANG = $LOCAL_LANG;
				if (is_array($this->conf['_LOCAL_LANG.']))	{
					reset($this->conf['_LOCAL_LANG.']);
					while(list($k,$lA)=each($this->conf['_LOCAL_LANG.']))	{
						if (is_array($lA))	{
							$k = substr($k,0,-1);
							$this->LOCAL_LANG[$k] = t3lib_div::array_merge_recursive_overrule(is_array($this->LOCAL_LANG[$k])?$this->LOCAL_LANG[$k]:array(), $lA);
						}
					}
				}
			}
		
		}
		$this->LOCAL_LANG_loaded = 1;
	}




	/*
	Clean up for flash
	*/

	function makeAbsolutePaths($value){
		$siteUrl = t3lib_div::getIndpEnv('TYPO3_SITE_URL');
		$value = eregi_replace('src="fileadmin','src="'.$siteUrl.'fileadmin',$value);
		$value = eregi_replace('src="uploads','src="'.$siteUrl.'uploads',$value);
		return $value;
	}
	
	function cleanHTML($value){

		$value = eregi_replace('<strong>','<b>',$value);
		$value = eregi_replace('</strong>', '</b>', $value);
		$value = eregi_replace('','"',$value);
		$value = eregi_replace('','"',$value);
		$value = eregi_replace('','\'',$value);

		/*$value = eregi_replace('
','',$value);*/
		$value = eregi_replace('
','<br/>',$value);

		return $value;
	
	}

	/*
	These functions are extracted from t3lib_parsehtml_proc in order to transform typo3 db text content into flash friendly html.
	You can add a wrap for styling, eg '<u>|</u>'
	*/
	
	function TS_links_rte($value,$wrap='')	{
		$htmlParser = t3lib_div::makeInstance('t3lib_parsehtml_proc');

		$value = $htmlParser->TS_AtagToAbs($value);
		$wrap = explode('|',$wrap);
			// Split content by the TYPO3 pseudo tag "<LINK>":
		$blockSplit = $htmlParser->splitIntoBlock('link',$value,1);
		foreach($blockSplit as $k => $v)	{
			$error = '';
			if ($k%2)	{	// block:
				$tagCode = t3lib_div::trimExplode(' ',trim(substr($htmlParser->getFirstTag($v),0,-1)),1);
				$link_param = $tagCode[1];
				$href = '';
				$siteUrl = $htmlParser->siteUrl();
					// Parsing the typolink data. This parsing is roughly done like in tslib_content->typolink()
				if(strstr($link_param,'@'))	{		// mailadr
					$href = 'mailto:'.eregi_replace('^mailto:','',$link_param);
				} elseif (substr($link_param,0,1)=='#') {	// check if anchor
					$href = $siteUrl.$link_param;
				} else {
					$fileChar=intval(strpos($link_param, '/'));
					$urlChar=intval(strpos($link_param, '.'));

						// Detects if a file is found in site-root OR is a simulateStaticDocument.
					list($rootFileDat) = explode('?',$link_param);
					$rFD_fI = pathinfo($rootFileDat);
					if (trim($rootFileDat) && !strstr($link_param,'/') && (@is_file(PATH_site.$rootFileDat) || t3lib_div::inList('php,html,htm',strtolower($rFD_fI['extension']))))	{
						$href = $siteUrl.$link_param;
					} elseif($urlChar && (strstr($link_param,'//') || !$fileChar || $urlChar<$fileChar))	{	// url (external): If doubleSlash or if a '.' comes before a '/'.
						if (!ereg('^[a-z]*://',trim(strtolower($link_param))))	{$scheme='http://';} else {$scheme='';}
						$href = $scheme.$link_param;
					} elseif($fileChar)	{	// file (internal)
						$href = $siteUrl.$link_param;
					} else {	// integer or alias (alias is without slashes or periods or commas, that is 'nospace,alphanum_x,lower,unique' according to tables.php!!)
						$link_params_parts = explode('#',$link_param);
						$idPart = trim($link_params_parts[0]);		// Link-data del
						if (!strcmp($idPart,''))	{ $idPart=$htmlParser->recPid; }	// If no id or alias is given, set it to class record pid
						if ($link_params_parts[1] && !$sectionMark)	{
							$sectionMark = '#'.trim($link_params_parts[1]);
						}
							// Splitting the parameter by ',' and if the array counts more than 1 element it's a id/type/? pair
						$pairParts = t3lib_div::trimExplode(',',$idPart);
						if (count($pairParts)>1)	{
							$idPart = $pairParts[0];
							// Type ? future support for?
						}
							// Checking if the id-parameter is an alias.
						if (!t3lib_div::testInt($idPart))	{
							list($idPartR) = t3lib_BEfunc::getRecordsByField('pages','alias',$idPart);
							$idPart = intval($idPartR['uid']);
						}
						//$page = t3lib_BEfunc::getRecord('pages', $idPart);//this doesnt work at the moment...no page exist check
						//if (is_array($page))	{	// Page must exist...
							$href = $siteUrl.'?id='.$link_param;
						/*} else {
							#$href = '';
							$href = $siteUrl.'?id='.$link_param;
							$error = 'No page found: '.$idPart;
						}*/
					}
				}
				
				// Setting the A-tag:
				$bTag = '<a href="'.htmlspecialchars($href).'"'.($tagCode[2]&&$tagCode[2]!='-' ? ' target="'.htmlspecialchars($tagCode[2]).'"' : '').'>'.$wrap[0];
				$eTag = $wrap[1].'</a>';
				$blockSplit[$k] = $bTag.$htmlParser->TS_links_rte($htmlParser->removeFirstAndLastTag($blockSplit[$k])).$eTag;
			}
		}

			// Return content:
		return implode('',$blockSplit);
	}




	/**
	 * Loads local-language values by looking for a "locallang.php" file in the plugin class directory ($this->scriptRelPath) and if found includes it.
	 * Also locallang values set in the TypoScript property "_LOCAL_LANG" are merged onto the values found in the "locallang.php" file.
	 *
	 * @return	void
	 Borg: this is the ver4.o 
	 */
	/*function pi_loadLL()	{
		if (!$this->LOCAL_LANG_loaded && $this->scriptRelPath)	{
			$basePath = t3lib_extMgm::extPath($this->extKey).dirname($this->scriptRelPath).'/locallang.php';

				// php or xml as source: In any case the charset will be that of the system language.
				// However, this function guarantees only return output for default language plus the specified language (which is different from how 3.7.0 dealt with it)
			$this->LOCAL_LANG = t3lib_div::readLLfile($basePath,$this->LLkey);
			if ($this->altLLkey)	{
				$tempLOCAL_LANG = t3lib_div::readLLfile($basePath,$this->altLLkey);
				$this->LOCAL_LANG = array_merge(is_array($this->LOCAL_LANG) ? $this->LOCAL_LANG : array(),$tempLOCAL_LANG);
			}

				// Overlaying labels from TypoScript (including fictitious language keys for non-system languages!):
			if (is_array($this->conf['_LOCAL_LANG.']))	{
				reset($this->conf['_LOCAL_LANG.']);
				while(list($k,$lA)=each($this->conf['_LOCAL_LANG.']))	{
					if (is_array($lA))	{
						$k = substr($k,0,-1);
						foreach($lA as $llK => $llV)	{
							if (!is_array($llV))	{
								$this->LOCAL_LANG[$k][$llK] = $llV;
								if ($k != 'default')	{
									$this->LOCAL_LANG_charset[$k][$llK] = $GLOBALS['TYPO3_CONF_VARS']['BE']['forceCharset'];	// For labels coming from the TypoScript (database) the charset is assumed to be "forceCharset" and if that is not set, assumed to be that of the individual system languages (thus no conversion)
								}
							}
						}
					}
				}
			}
		}
		$this->LOCAL_LANG_loaded = 1;
	}



*/
	/*****************************************************************
						NEWS FUNCTIONS
	******************************************************************/

        function getNews($tObj=null) {
			global $BE_USER,$FE_USER,$EXEC_TIME,$TYPO3_DB,$TT,$TSFE;
			$uid = $GLOBALS['FE_USER']->user['uid'];
			$ug =  $GLOBALS['FE_USER']->user['usergroup'];
	

			if($FE_USER->user['uid']>0){
				//logged in
				if($FE_USER->user['usergroup']){
				//should be in usergroup but if not to prevent sql error
					$ug = $FE_USER->user['usergroup'] .',';
				}else{
					$ug='';
				}
				$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';

			}else{
				//-1 hide at login, -2 show at login
				$fe_access =' AND fe_group IN (0,-1)';
			}

			if($tObj['showTimedPage']){
				$time = '';
			}else{
				$time =' AND tt_news.starttime<='.$EXEC_TIME.' AND (tt_news.endtime=0 OR tt_news.endtime>'.$EXEC_TIME.')';
			}



			$tObj['loginstatus'] = $fe_access;

			if(!$tObj['no_cache']){
				$t = serialize($tObj);
				$hash = md5($t);
				$c = $this->getHash($hash,0);
				$content = unserialize($c);
				if(is_array($content)){
					return $content;
					die;
				}

			}



			if($tObj['uid']!=null){
				$where = 'uid IN('.$tObj['uid'].')';
			}else if($tObj['pid']!=null){
				$where = 'pid IN('.$tObj['pid'].') AND NOT l18n_parent>0 ';
			}else{
				$where = '';

			}



			$where.=$fe_access . ' AND NOT deleted AND NOT hidden' . $time;
			if($tObj['orderBy'] != null){
				$orderBy = $tObj['orderBy'];
			}else{
				$orderBy = 'tt_news.datetime DESC';
			}



			if($tObj['limit'] != null){
				$limit = $tObj['limit'];
			}else{
				$limit = '';
			}

			$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tt_news', $where, '',$orderBy,$limit);
			$arr = array();

			while($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res)){
				/*if($tObj['L']>0){
					$r[] = $row;
				}else{*/
					//$row['path'] = 'uploads/pics/';

					$arr[] = $this->getRecordInLangArray($row['uid'],'tt_news',array('uid','pid','tstamp','crdate','cruser_id','title','datetime','image','imagecaption','imagealttext','imagetitletext','related','short','author','author_email','category','news_files','links','type','page','keywords','archivedate','ext_url','sys_language_uid','l18n_parent','thumb','flash_thumb'),array('bodytext'),$tObj['wrap']);

			}

			$arr['path'] = 'uploads/pics/';

			/*

			Save to cache

			*/

			if($tObj['no_cache']){
				//Wasn't done above if so
				$t = serialize($tObj);
				$hash = md5($t);
			}

			$data = serialize($arr);
		

			$this->storeHash($hash,$data,'REMOTING_news');
			$err = mysql_error(); 

			if($err==''){
				return array('result'=>$arr,'callback'=>$tObj['callback']);

			}else {
				$error = array('errortype'=>1,'errormsg'=>$err);
				return $error;
			}

		}

	
	

        function getNewsFromCategories($tObj=null) {
			global $BE_USER,$FE_USER,$EXEC_TIME,$TYPO3_DB,$TT,$TSFE;
			$uid = $GLOBALS['FE_USER']->user['uid'];
			$ug =  $GLOBALS['FE_USER']->user['usergroup'];

		

			if($FE_USER->user['uid']>0){
				//logged in
				if($FE_USER->user['usergroup']){
				//should be in usergroup but if not to prevent sql error
					$ug = $FE_USER->user['usergroup'] .',';
				}else{
					$ug='';
				}

				$fe_access = ' AND tt_news.fe_group IN ('.$ug.'0,-2) AND tt_news.fe_group !=-1';

			}else{
				//-1 hide at login, -2 show at login
				$fe_access =' AND tt_news.fe_group IN (0,-1)';
			}



			if($tObj['showTimedPage']){
				$time = '';
			}else{
				$time =' AND tt_news.starttime<='.$EXEC_TIME.' AND (tt_news.endtime=0 OR tt_news.endtime>'.$EXEC_TIME.')';
			}



			$tObj['loginstatus'] = $fe_access;

			if(!$tObj['no_cache']){
				$t = serialize($tObj);
				$hash = md5($t);
				$c = $this->getHash($hash,0);
				$content = unserialize($c);
				if(is_array($content)){
					return $content;
					die;
				}
			}





			if($tObj['categories']!=null){
				$where = 'tt_news_cat_mm.uid_foreign IN("'.$tObj['categories'].'") AND tt_news.uid=tt_news_cat_mm.uid_local';
			}else{
				$where = '';
			}

			$where.=$fe_access . ' AND NOT tt_news.deleted AND NOT tt_news.hidden'.$time;

			

			//make sure only to get orig translations

			$where.=' AND NOT tt_news.l18n_parent>0';

			

			if($tObj['orderBy'] != null){
				$orderBy = 'tt_news.'.$tObj['orderBy'];
			}else{
				$orderBy = 'tt_news.datetime DESC';
			}


			if($tObj['limit'] != null){
				$limit = $tObj['limit'];
			}else{
				$limit = '';
			}


			//in multiple select the last table name will be the one whose uid takes precedence..in this case tt_news

			$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tt_news_cat_mm,tt_news', $where, '',$orderBy,$limit);

			$arr = array();

			while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res)) {
				//note: the row category value only reflects the number of records not their uids


				$arr[] =$this->getRecordInLangArray($row['uid'],'tt_news',array('uid','pid','tstamp','crdate','cruser_id','title','datetime','image','imagecaption','imagealttext','imagetitletext','related','short','author','author_email','category','news_files','links','type','page','keywords','archivedate','ext_url','sys_language_uid','l18n_parent','thumb','flash_thumb'),array('bodytext'),$tObj['wrap']);

				

			

			}

			$arr['path'] = 'uploads/pics/';

			/*
	
			Save to cache

			*/

			if($tObj['no_cache']){
				//Wasn't done above if so
				$t = serialize($tObj);
				$hash = md5($t);
			}

			$data = serialize($arr);
			$this->storeHash($hash,$data,'REMOTING_news');
			$err = mysql_error(); 

			if($err==''){

				return array('result'=>$arr,'callback'=>$tObj['callback']);

			}else {

				$error = array('errortype'=>1,'errormsg'=>$err);

				return $error;

			}

		}

	



	function getNewsCategories($pObj){
		global $TSFE,$EXEC_TIME,$FE_USER,$BE_USER,$FLAT_LIST;

		if(!strlen($pObj['uid'])>0){

			return $pObj;

		}


		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';
		}


		/*

		First check if already cached

		Needs to consider login status

		*/

		$pObj['loginstatus'] = $fe_access;

		if(!$pObj['no_cache']){

			$t = serialize($pObj);

			$hash = md5($t);

			$c = $this->getHash($hash,0);

			$menu = unserialize($c);

			if(is_array($menu)){

				return $menu;

				die;

			}

		}

		$FLAT_LIST = array();//reset this list so it can be filled at each call

		

		$arr['root']= $this->getNewsCategoryObject($pObj['uid'],$pObj);
		$err = mysql_error(); 
		if($err!=''){
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;

		}


		$arr['flatlist'] = $FLAT_LIST;



		//used in flash to know which of several components called...can be used instead of unique callback

		$arr['menuId'] = $pObj['menuId'];

		/*

		Save to cache

		*/

		if($pObj['no_cache']){
			//Wasn't done above if so
			$t = serialize($pObj);
			$hash = md5($t);
		}

		$data = array('result'=>$arr,'callback'=>$pObj['callback']);
		$data = serialize($data);
		$this->storeHash($hash,$data,'REMOTING_newscat');

	

		$err = mysql_error(); 
		if($err==''){
			return array('result'=>$arr,'callback'=>$pObj['callback']);
		}else {
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;

		}

	}



	function getNewsCategoryObject($uid=null,$pObj){

		global $TSFE,$EXEC_TIME,$FE_USER,$BE_USER,$FLAT_LIST;

		$obj = array('subcat'=> array(),'items'=> array(),'lang'=> array());

		if($FE_USER->user['uid']>0){
			//logged in
			if($FE_USER->user['usergroup']){
			//should be in usergroup but if not to prevent sql error
				$ug = $FE_USER->user['usergroup'] .',';
			}else{
				$ug='';
			}
			$fe_access = ' AND fe_group IN ('.$ug.'0,-2) AND fe_group !=-1';
		}else{
			//-1 hide at login, -2 show at login
			$fe_access =' AND fe_group IN (0,-1)';

		}
		

		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tt_news,tt_news_cat_mm', ' NOT tt_news.deleted AND NOT tt_news.hidden AND tt_news.uid=tt_news_cat_mm.uid_local AND NOT tt_news.l18n_parent>0 AND tt_news_cat_mm.uid_foreign = '.$uid.' AND tt_news.starttime<='.$EXEC_TIME.' AND (tt_news.endtime=0 OR tt_news.endtime>'.$EXEC_TIME.') '.$fe_access,'','tt_news.sorting');

		//$obj['items'] =  $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res0);
		$orderedRecs = array();

		//store different rows on their syslang uid
		$err = mysql_error(); 
		if($err!=''){
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;
			die;
		}
		
		while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{
			$row['l18n_diffsource'] = '';
			$lang = array('lang'=>array());
			$lang['lang'][0] = $lang['lang'][$row['sys_language_uid']] = $row;//add row as both default and zero...bit tricky when same page tree has several different default languages...there is room for user input error
			//we wanna save overlays with the record, not as separate tables...cause that would be trickier to translate

			$OLres = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tt_news', ' NOT tt_news.deleted AND NOT tt_news.hidden AND tt_news.l18n_parent= '.$row['uid'].' AND tt_news.starttime<='.$EXEC_TIME.' AND (tt_news.endtime=0 OR tt_news.endtime>'.$EXEC_TIME.') '.$fe_access,'','tt_news.sorting');
		

			while ($OLrow = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($OLres))	{
				$OLrow['l18n_diffsource'] = '';
				$lang['lang'][$OLrow['sys_language_uid']] = $OLrow;
			}

			$orderedRecs[] =  $lang;

		}
		$err = mysql_error(); 
		if($err!=''){
			$error = array('errortype'=>1,'errormsg'=>$err);
			return $error;
			die;
		}
		$obj['items'] = $orderedRecs;
		$FLAT_LIST = array_merge($FLAT_LIST, $obj['items']);

		//Get language overlays

		$res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tt_news_cat', 'NOT deleted AND NOT hidden AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') AND uid = '.$uid.$fe_access,'','sorting');	

		while ($row = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res))	{

			$row['path'] = 'uploads/pics/';



			//Append alternative languages if any...separated by pipe

			$obj['lang'][0]= $row;

			$OL = explode('|',$row['title_lang_ol']);

			foreach($OL as $k=>$v){

				$obj['lang'][$k+1] = array('title'=>$v);

			}


			//get children

			$res2 = $GLOBALS['TYPO3_DB']->exec_SELECTquery('*', 'tt_news_cat', 'NOT deleted AND NOT hidden AND starttime<='.$EXEC_TIME.' AND (endtime=0 OR endtime>'.$EXEC_TIME.') AND parent_category = '.$uid.$fe_access,'','title');		

	while ($row2 = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res2))	{

				$obj['subcat'][] = $this->getNewsCategoryObject($row2['uid'],$pObj);

				

			}

		}

		return $obj;

	}


}
?>
